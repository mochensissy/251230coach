# 好学伴 免费增值会员系统实现方案

## 概述

将现有的「注册需要密钥」模式改为 **免费增值模式**：
- **免费用户**：可以免费注册使用基础功能
- **会员用户**：购买密钥激活会员，解锁全部功能

## 功能限制对比

| 功能 | 免费用户 | 会员用户 |
|------|---------|---------|
| 基础打卡功能 | ✅ | ✅ |
| 成长树/积分系统 | ✅ | ✅ |
| 奖励兑换 | ✅ | ✅ |
| 成绩分析系统 | ✅ | ✅ |
| 科目数量 | ≤ 4 个 | 无限制 |
| 云同步功能 | ❌ | ✅ |
| 图片识别导入 | ❌ | ✅ |

---

## 技术实现方案

### 一、数据库改造

#### 1.1 修改 User 模型

**文件**: [schema.prisma](file:///Users/hubai/Documents/AI提效项目开发/251220xiugandaka/server/prisma/schema.prisma)

```diff
model User {
  id                 String   @id @default(cuid())
  phone              String?  @unique
  email              String?  @unique
  passwordHash       String
  parentPasswordHash String?
  role               String   @default("user")
+ membershipType     String   @default("free")  // free / premium
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  lastLoginAt        DateTime?
  
  children           Child[]
  rewards            Reward[]
  productKey         ProductKey?

  @@map("users")
}
```

---

### 二、后端 API 改造

#### 2.1 修改注册流程

**文件**: [authService.ts](file:///Users/hubai/Documents/AI提效项目开发/251220xiugandaka/server/src/services/authService.ts)

**改动内容**:
- `productKey` 参数改为**可选**
- 如果没有提供 `productKey`，创建 `membershipType: 'free'` 的用户
- 如果提供了有效 `productKey`，创建 `membershipType: 'premium'` 的用户

#### 2.2 新增激活会员接口

**新建文件**: `server/src/routes/membership.ts`

```typescript
// POST /api/membership/activate
// 用于已注册的免费用户通过密钥激活会员
// 请求: { productKey: string }
// 响应: { success: true, membershipType: 'premium' }
```

#### 2.3 返回会员状态

**修改登录和用户信息接口**，在响应中包含 `membershipType`

---

### 三、前端功能限制实现

#### 3.1 全局会员状态管理

**修改**: `client/src/store/authStore.ts`
- 在登录成功后保存 `membershipType` 到状态
- 提供 `isFree` / `isPremium` 计算属性

#### 3.2 各功能限制点

##### 3.2.1 科目数量限制 (≤ 4)

**相关文件**: 
- 添加计划弹窗
- 科目管理相关组件

**实现逻辑**:
```typescript
const MAX_FREE_SUBJECTS = 4;

// 在添加科目时检查
if (membershipType === 'free' && currentSubjectCount >= MAX_FREE_SUBJECTS) {
  showUpgradeDialog('科目数量已达上限，升级会员可添加更多科目');
  return;
}
```

##### 3.2.2 云同步限制

**相关文件**: 
- [useSync.ts](file:///Users/hubai/Documents/AI提效项目开发/251220xiugandaka/client/src/hooks/useSync.ts)
- [SyncButton.tsx](file:///Users/hubai/Documents/AI提效项目开发/251220xiugandaka/client/src/components/common/SyncButton.tsx)

**UI 改动**:
- 免费用户：同步按钮显示锁图标 🔒，点击弹出升级提示
- 会员用户：正常显示同步按钮

##### 3.2.3 图片识别限制

**文件**: [BatchAddDialog.tsx](file:///Users/hubai/Documents/AI提效项目开发/251220xiugandaka/client/src/components/plan/BatchAddDialog.tsx)

**UI 改动**:
- 免费用户：相机按钮置灰或显示锁图标，点击弹出升级提示

---

### 四、会员购买入口

#### 4.1 购买入口位置

在以下位置添加「升级会员」入口：
- 侧边栏底部（设置区域附近）
- 个人中心/设置页面

**已是会员**：入口处显示「已是会员」标识，无需单独的会员中心页面

#### 4.2 购买方式弹窗

**新建文件**: `client/src/components/common/PurchaseMembershipDialog.tsx`

弹窗内容包含两种购买渠道：

##### 渠道一：小红书购买（国内用户）

- 展示小红书账号/二维码
- 引导用户在小红书私信购买密钥
- 提供「输入密钥激活」按钮

##### 渠道二：Stripe 在线支付（海外用户）

- 展示「在线支付」按钮
- 点击后跳转 Stripe Checkout 页面
- 支付成功后自动激活会员

> **注意**：Stripe 支付功能预计 2025 年 1 月开通香港卡后启用，初期可先隐藏此选项或显示「即将开放」。

#### 4.3 激活密钥弹窗

**新建文件**: `client/src/components/common/ActivateKeyDialog.tsx`

- 输入密钥输入框
- 调用 `/api/membership/activate` 接口
- 成功后刷新全局会员状态，解锁所有功能

---

### 五、Stripe 支付集成（2025年1月后）

#### 5.1 后端实现

**新建文件**: `server/src/routes/payment.ts`

```typescript
// POST /api/payment/create-checkout
// 创建 Stripe Checkout Session
// 返回: { url: 'https://checkout.stripe.com/...' }

// POST /api/payment/webhook
// Stripe Webhook 回调
// 支付成功后自动创建密钥并激活用户会员
```

#### 5.2 前端实现

- 点击「在线支付」→ 调用接口获取 Checkout URL → 跳转支付
- 支付完成后返回应用，自动刷新会员状态

---

## 实现顺序

### 阶段一：数据库与后端（预计 1-2 小时）

1. [ ] 修改 Prisma schema，添加 `membershipType` 字段
2. [ ] 运行数据库迁移
3. [ ] 修改 `authService.register()`，支持免密钥注册
4. [ ] 新增 `/api/membership/activate` 接口
5. [ ] 修改登录/用户信息接口，返回 `membershipType`

### 阶段二：前端状态管理（预计 30 分钟）

6. [ ] 扩展 `authStore.ts`，保存会员状态

### 阶段三：功能限制实现（预计 1-2 小时）

7. [ ] 实现云同步限制
8. [ ] 实现科目数量限制（4 个）
9. [ ] 实现图片识别限制

### 阶段四：购买入口 UI（预计 1 小时）

10. [ ] 创建「升级会员」入口（侧边栏/设置页）
11. [ ] 创建购买方式弹窗（小红书引导 + 密钥激活）
12. [ ] 会员用户显示「已是会员」标识

### 阶段五：Stripe 集成（2025年1月后）

13. [ ] 后端：Stripe Checkout 接口
14. [ ] 后端：Stripe Webhook 处理
15. [ ] 前端：在线支付按钮与流程

---

## 验证计划

### 手动测试步骤

#### 测试 1：免费用户注册

1. 访问注册页面
2. 不填写密钥，直接注册
3. 验证：注册成功，会员功能显示锁定状态

#### 测试 2：科目数量限制

1. 以免费用户登录
2. 添加 4 个科目
3. 尝试添加第 5 个科目
4. 验证：弹出升级提示，无法添加

#### 测试 3：云同步限制

1. 以免费用户登录
2. 点击同步按钮
3. 验证：弹出升级提示

#### 测试 4：密钥激活会员

1. 以免费用户登录
2. 点击「升级会员」入口
3. 输入有效密钥激活
4. 验证：状态刷新为会员，所有限制解除

#### 测试 5：现有付费用户兼容性

1. 使用现有已注册账号登录
2. 验证：仍为会员状态，功能正常

---

## 已确认的决策

1. **现有用户迁移**：所有现有用户（已通过密钥注册）默认设置为 `premium`
2. **升级弹窗内容**：展示小红书二维码，引导用户扫码购买

