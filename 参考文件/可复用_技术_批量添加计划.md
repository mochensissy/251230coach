# 可复用_技术_批量添加计划

## 需求描述
允许用户通过粘贴文本或上传/拍照图片的方式，批量解析并创建多个任务。
核心流程：图片 -> OCR文字 -> 智能解析 -> 预览修改 -> 批量创建。

## 技术选型
*   **OCR**: 使用 `tesseract.js` (纯前端实现，无需后端 OCR 服务，保护隐私且免费)。
*   **解析**: 正则表达式 (Regex) + 启发式规则。

## 实现步骤

### 1. 引入 Tesseract.js
安装依赖：`npm install tesseract.js`

为了优化加载（特别是国内环境或移动端），建议将 `worker.min.js` 和核心 `wasm` 文件放到本地 `public` 目录，而不是走 CDN。

```typescript
// BatchAddDialog.tsx -> OCR 初始化
const worker = await createWorker('chi_sim', 1, {
    workerPath: '/tesseract/worker.min.js',
    corePath: '/tesseract/tesseract-core.wasm.js',
    langPath: '/tessdata', // 语言包也可以本地化
});
```

### 2. 智能文本解析逻辑
用户输入的文本通常是无序的，包含科目名和任务项。解析逻辑如下：

```typescript
function parseOCRText(text: string, subjects: Subject[]) {
    // 按行分割
    const lines = text.split('\n');
    let currentSubject = null;
    const tasks = [];

    lines.forEach(line => {
        // 1. 尝试匹配科目
        // 如果行内容包含某个已存在的科目名（如 "数学"），则更新当前上下文
        const matchedSubject = subjects.find(s => line.includes(s.name));
        if (matchedSubject) {
            currentSubject = matchedSubject;
            return;
        }

        // 2. 尝试匹配任务
        // 常见格式： "1. 做作业", "2、背单词", 或者在有科目上下文时的任意文本
        const isTask = /^\d+[.、\s]/.test(line) || (currentSubject && line.trim());
        
        if (isTask) {
            tasks.push({
                subjectId: currentSubject?.id || 'default_other',
                name: line.replace(/^\d+[.、\s]*/, '').trim(), // 去掉序号
                duration: 30, // 默认时长
                rewardPoints: 10 // 默认积分
            });
        }
    });
    return tasks;
}
```

### 3. 实现粘贴图片上传
监听 `paste` 事件，支持直接从剪贴板粘贴截图（PC端非常常用）。

```typescript
useEffect(() => {
    const handlePaste = (e: ClipboardEvent) => {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                if (file) handleOCR(file); // 调用 OCR 处理
            }
        }
    };
    window.addEventListener('paste', handlePaste);
    return () => window.removeEventListener('paste', handlePaste);
}, []);
```

### 4. 预览与批量提交
*   **预览界面**：解析后的结果展示为表格或列表，允许用户修改解析错误的科目或文字。
*   **批量保存**：循环调用 `planRepo.create()`。

```typescript
const handleSave = async () => {
    // 开启 loading
    setIsSubmitting(true);
    try {
        // 使用 Promise.all 并发创建，或者 for...of 串行创建（建议串行，因为 indexedDB 并发有压力）
        for (const task of parsedTasks) {
           await planRepo.create({ ...task });
        }
        onSuccess();
    } finally {
        setIsSubmitting(false);
    }
};
```
