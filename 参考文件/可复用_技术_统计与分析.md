# 可复用_技术_统计分析模块

## 需求描述
展示可视化的学习数据，帮助用户分析学习情况。
1.  **数据概览**：总时长、完成率、最佳学习日。
2.  **趋势图**：每日学习时长折线图。
3.  **分布图**：各科目时间占比饼图。
4.  **详情表**：科目维度的详细统计（次数、时长）。

## 技术选型
*   **前端图表库**：`Chart.js` + `react-chartjs-2` (轻量、常用、响应式好) 或 `Recharts` (React原生由D3封装)。
*   **数据聚合**: 前端实时聚合 (Client-side Aggregation)。对于 IndexedDB 这种本地库，通常直接查出原始记录 (`rawRecords`)，然后在前端 JS 中进行 `reduce` 计算，避免复杂的 SQL 聚合查询。

## 实现逻辑

### 1. 数据获取 Hook (useStats)
封装一个 hook 专门处理数据聚合。

```typescript
// hooks/useStats.ts
export function useStats(childId, startDate, endDate) {
    const [stats, setStats] = useState(null);

    useEffect(() => {
        // 1. 获取范围内的所有打卡记录
        const records = await checkInRepo.getRecordsByDateRange(childId, startDate, endDate);
        
        // 2. 聚合处理
        // 按日期聚合 (趋势图)
        const dailyMap = {}; 
        // 按科目聚合 (饼图)
        const subjectMap = {};

        records.forEach(r => {
            // Daily Stats
            const day = r.date;
            if (!dailyMap[day]) dailyMap[day] = 0;
            dailyMap[day] += r.duration;

            // Subject Stats
            const subId = r.subjectId;
            if (!subjectMap[subId]) subjectMap[subId] = { duration: 0, count: 0 };
            subjectMap[subId].duration += r.duration;
            subjectMap[subId].count += 1;
        });

        setStats({ dailyStats: dailyMap, subjectStats: subjectMap });
    }, [childId, startDate, endDate]);

    return stats;
}
```

### 2. 图表组件封装
将具体的 Chart.js 配置封装在组件内部，外部只传 `data`。

```typescript
// components/charts/TimeChart.tsx
import { Line } from 'react-chartjs-2';

export function TimeChart({ data }) {
    const chartData = {
        labels: Object.keys(data), // 日期数组
        datasets: [{
            label: '学习时长(分钟)',
            data: Object.values(data).map(d => Math.round(d / 60)), // 秒转分
            borderColor: '#primary-color',
            tension: 0.4 // 平滑曲线
        }]
    };
    
    return <Line data={chartData} options={{ responsive: true }} />;
}
```

### 3. 注意事项
*   **空数据补全**：展示趋势图时，如果某天没有数据，不要直接跳过，而应该补 `0`，否则日期轴会不连续，误导用户。
*   **日期格式化**：X轴显示的日期尽量简短（如 "12-01"），Tooltip 中再显示完整日期。
*   **颜色统一**：科目饼图的颜色应与系统中该科目的代表色保持一致 (`subject.color`)，增强认知关联。
