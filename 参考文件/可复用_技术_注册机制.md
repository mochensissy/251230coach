# 可复用_技术_注册机制

## 需求描述
简化用户注册流程，在一个步骤中同时完成“账号注册”和“初始化配置（如创建第一个孩子档案）”。

## 流程设计

1.  **统一表单**：将注册字段和初始化字段合并。
    *   **账号信息**: 手机号/用户名、密码。
    *   **档案信息**: 孩子昵称、年级、学段。
2.  **原子化提交**：后端接口同时接收所有数据，并在一个事务中处理。

## 前端实现 (React Hook Form + Zod)

使用 `zod` 进行复杂的表单校验（如密码一致性校验）。

```typescript
// RegisterPage.tsx
const registerSchema = z.object({
  account: z.string().min(3),
  password: z.string().min(6),
  confirmPassword: z.string(),
  // 业务初始化字段
  childName: z.string().min(1),
  childGrade: z.number().min(1).max(12),
}).refine((data) => data.password === data.confirmPassword, {
  message: '两次密码不一致',
  path: ['confirmPassword'],
});

const onSubmit = async (data) => {
    // 调用聚合注册接口
    await api.auth.register({
        username: data.account,
        password: data.password,
        initialChild: {
            name: data.childName,
            grade: data.childGrade
        }
    });
};
```

## 后端实现 (Transaction)

确保“人注册了但没档案”的脏数据不会产生。

```typescript
// authController.ts
async function register(req, res) {
    const { username, password, initialChild } = req.body;
    
    await db.transaction(async (trx) => {
        // 1. 创建 User
        const user = await db.users.create({ username, passwordHash }, trx);
        
        // 2. 创建 Child (关联 User)
        await db.children.create({
            userId: user.id,
            name: initialChild.name,
            grade: initialChild.grade
        }, trx);
        
        // 3. (可选) 上下文初始化
        // 如：赋予默认头像、发送欢迎邮件等
    });
    
    return { token: generateToken(user) };
}
```

## 复用建议
对于 B2C 应用，**减少注册步骤**是提高转化率的关键。
将“注册”和“Onboarding (新手引导)”的第一步合并，让用户注册完立刻就能进入可用的业务状态，而不是面对一个空的 Dashboard。
