# 可复用_技术_本地数据库架构 (IndexedDB + Dexie)

## 需求描述
构建一个支持离线访问、高性能、强类型的本地数据库层。需支持复杂的表关联、版本迭代（Migration）和 TypeScript 类型推导。

## 技术选型
*   **Dexie.js**: IndexedDB 的最佳封装库，API 优雅，支持 Promise。
*   **TypeScript**: 定义强类型的 Table Schema。

## 架构最佳实践

### 1. 单例模式与类型定义
建议在一个文件 (`db/database.ts`) 中集中定义所有表结构。

```typescript
import Dexie, { type EntityTable } from 'dexie';

// 1. 定义数据接口 (Interface)
export interface Todo {
  id: string;
  title: string;
  isDone: boolean;
  createdAt: Date;
}

// 2. 继承 Dexie 类
class MyAppDatabase extends Dexie {
  // 3. 声明强类型表
  todos!: EntityTable<Todo, 'id'>; // 主键名为 id

  constructor() {
    super('MyAppDB');
    
    // 4. 定义 Schema & 索引
    // 注意：只列出需要索引的字段，不要列出所有字段！
    this.version(1).stores({
      todos: 'id, title, isDone, createdAt' 
    });
  }
}

export const db = new MyAppDatabase();
```

### 2. 数据库迁移 (Migration)
随着业务发展，表结构会变化。Dexie 的 `.upgrade()` 方法可以轻松处理数据迁移。

```typescript
this.version(2).stores({
  todos: 'id, title, isDone, createdAt, tag' // 新增 tag 索引
}).upgrade(tx => {
  // 可以在这里修改现有数据
  return tx.table('todos').toCollection().modify(todo => {
    todo.tag = 'default';
  });
});
```

### 3. Repository 模式 (推荐)
不要在 UI 组件中直接调用 `db.todos.add()`，而是封装 Service/Repository 层，隔离数据库逻辑。

```typescript
// repositories/todoRepo.ts
export const todoRepo = {
  async getAll() {
    return await db.todos.orderBy('createdAt').reverse().toArray();
  },
  
  async create(title: string) {
    return await db.todos.add({
      id: crypto.randomUUID(),
      title,
      isDone: false,
      createdAt: new Date()
    });
  }
};
```

### 4. 常见坑点与解决方案
*   **Date 类型**: IndexedDB 原生支持存储 `Date` 对象，但 JSON 序列化（如传给后端时）会变成字符串。同步时可以统一转为 ISO String。
*   **多Tab并发**: IndexedDB 是多Tab共享的。如果使用 `useLiveQuery` (Dexie-React-Hooks)，一个 Tab 修改数据，其他 Tab 会自动刷新 UI，无需手动 EventBus。
*   **性能**: 避免在大循环中一条条 `add()`，使用 `bulkAdd()` 性能提升 100 倍。

## 复用价值
此架构是 Local-First 应用的基石，完全可复用于任何需要离线存储的项目（如笔记应用、任务管理、本地工具等）。
