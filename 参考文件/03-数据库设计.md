# æ•°æ®åº“è®¾è®¡

## ä¸€ã€Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ç”¨æˆ·ç›¸å…³ ====================

/// ç”¨æˆ·è¡¨ - ä¸€ä¸ªè´¦å·ä»£è¡¨ä¸€ä¸ªå®¶åº­
model User {
  id                String   @id @default(cuid())
  phone             String?  @unique  // æ‰‹æœºå·ç™»å½•
  email             String?  @unique  // é‚®ç®±ç™»å½•
  passwordHash      String             // ç™»å½•å¯†ç å“ˆå¸Œ
  parentPasswordHash String            // å®¶é•¿ç®¡ç†å¯†ç å“ˆå¸Œ
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastLoginAt       DateTime?
  
  // å…³è”
  children          Child[]
  rewards           Reward[]
  
  @@map("users")
}

/// å°å­©æ¡£æ¡ˆè¡¨
model Child {
  id        String   @id @default(cuid())
  userId    String
  name      String             // å§“å/æ˜µç§°
  avatar    String?            // å¤´åƒï¼ˆé¢„è®¾å¤´åƒIDï¼‰
  grade     Int                // å¹´çº§ 1-6
  semester  String             // å­¦æœŸ first/second
  birthday  DateTime?          // ç”Ÿæ—¥
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // å…³è”
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskTemplates       TaskTemplate[]
  studyPlans          StudyPlan[]
  checkInRecords      CheckInRecord[]
  unlockedAchievements UnlockedAchievement[]
  rewardRedemptions   RewardRedemption[]
  examRecords         ExamRecord[]
  pointsLogs          PointsLog[]
  customAchievements  Achievement[]
  
  @@index([userId])
  @@map("children")
}

// ==================== ç§‘ç›®ä¸æ¨¡æ¿ ====================

/// ç§‘ç›®è¡¨
model Subject {
  id        String   @id @default(cuid())
  name      String             // ç§‘ç›®åç§°
  icon      String             // å›¾æ ‡ï¼ˆemojiæˆ–å›¾æ ‡åï¼‰
  color     String             // é¢œè‰²ä»£ç 
  isSystem  Boolean  @default(false)  // æ˜¯å¦ç³»ç»Ÿé¢„è®¾
  sortOrder Int      @default(0)      // æ’åº
  
  createdAt DateTime @default(now())
  
  // å…³è”
  taskTemplates TaskTemplate[]
  studyPlans    StudyPlan[]
  examRecords   ExamRecord[]
  
  @@map("subjects")
}

/// ä»»åŠ¡æ¨¡æ¿è¡¨
model TaskTemplate {
  id              String   @id @default(cuid())
  childId         String
  subjectId       String
  name            String             // ä»»åŠ¡åç§°
  description     String?            // ä»»åŠ¡è¯´æ˜
  defaultDuration Int      @default(30)  // é»˜è®¤æ—¶é•¿(åˆ†é’Ÿ)
  hasReward       Boolean  @default(true)  // æ˜¯å¦å¥–åŠ±ç§¯åˆ†
  showSummary     Boolean  @default(false) // ç»“æŸåå¼¹å‡ºå­¦ä¹ æ€»ç»“
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // å…³è”
  child      Child     @relation(fields: [childId], references: [id], onDelete: Cascade)
  subject    Subject   @relation(fields: [subjectId], references: [id])
  studyPlans StudyPlan[]
  
  @@index([childId])
  @@index([subjectId])
  @@map("task_templates")
}

// ==================== å­¦ä¹ è®¡åˆ’ä¸æ‰“å¡ ====================

/// å­¦ä¹ è®¡åˆ’è¡¨
model StudyPlan {
  id               String   @id @default(cuid())
  childId          String
  subjectId        String
  templateId       String?            // å…³è”çš„æ¨¡æ¿
  name             String             // ä»»åŠ¡åç§°
  description      String?            // ä»»åŠ¡è¯´æ˜
  
  // æ—¶é—´è®¾ç½®
  plannedStartTime String?            // è®¡åˆ’å¼€å§‹æ—¶é—´ HH:mm
  plannedEndTime   String?            // è®¡åˆ’ç»“æŸæ—¶é—´ HH:mm
  plannedDuration  Int?               // è®¡åˆ’æ—¶é•¿(åˆ†é’Ÿ)
  autoComplete     Boolean  @default(false)  // åˆ°æ—¶è‡ªåŠ¨å®Œæˆ
  
  // é‡å¤è®¾ç½®
  repeatType       String   @default("once")  // once/daily/weekday/weekend/custom
  repeatDays       Int[]    @default([])      // è‡ªå®šä¹‰é‡å¤æ—¥ [0-6]
  startDate        String             // å¼€å§‹æ—¥æœŸ YYYY-MM-DD
  endDate          String             // ç»“æŸæ—¥æœŸ YYYY-MM-DD
  
  // ç§¯åˆ†è®¾ç½®
  hasReward        Boolean  @default(true)
  rewardPoints     Int      @default(10)   // å®Œæˆå¥–åŠ±ç§¯åˆ†
  penaltyPoints    Int      @default(5)    // æœªå®Œæˆæ‰£é™¤ç§¯åˆ†
  
  // å…¶ä»–è®¾ç½®
  showSummary      Boolean  @default(false)
  isDeleted        Boolean  @default(false)  // è½¯åˆ é™¤
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // å…³è”
  child          Child           @relation(fields: [childId], references: [id], onDelete: Cascade)
  subject        Subject         @relation(fields: [subjectId], references: [id])
  template       TaskTemplate?   @relation(fields: [templateId], references: [id])
  checkInRecords CheckInRecord[]
  
  @@index([childId])
  @@index([subjectId])
  @@index([startDate, endDate])
  @@map("study_plans")
}

/// æ‰“å¡è®°å½•è¡¨
model CheckInRecord {
  id              String   @id @default(cuid())
  childId         String
  planId          String
  date            String             // æ‰“å¡æ—¥æœŸ YYYY-MM-DD
  
  // çŠ¶æ€
  status          String   @default("pending")
  // pending: æœªå¼€å§‹
  // in_progress: è¿›è¡Œä¸­
  // completed: å·²å®Œæˆ
  // overdue: é€¾æœŸå®Œæˆ
  // auto_completed: è‡ªåŠ¨å®Œæˆ
  // manual_completed: æ‰‹åŠ¨å®Œæˆ
  // missed: æœªå®Œæˆ(å½“å¤©å·²è¿‡)
  
  // å®é™…æ—¶é—´
  actualStartTime DateTime?          // å®é™…å¼€å§‹æ—¶é—´
  actualEndTime   DateTime?          // å®é™…ç»“æŸæ—¶é—´
  actualDuration  Int?               // å®é™…ç”¨æ—¶(ç§’)
  
  // ç§¯åˆ†
  earnedPoints    Int      @default(0)  // è·å¾—ç§¯åˆ†(å¯èƒ½ä¸ºè´Ÿ)
  
  // å­¦ä¹ æ€»ç»“
  summary         String?            // å­¦ä¹ æ€»ç»“å†…å®¹
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // å…³è”
  child     Child     @relation(fields: [childId], references: [id], onDelete: Cascade)
  plan      StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  @@unique([planId, date])  // æ¯ä¸ªè®¡åˆ’æ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
  @@index([childId])
  @@index([date])
  @@index([status])
  @@map("check_in_records")
}

// ==================== æˆå°±ç³»ç»Ÿ ====================

/// æˆå°±/å‹‹ç« è¡¨
model Achievement {
  id             String   @id @default(cuid())
  childId        String?            // nullè¡¨ç¤ºç³»ç»Ÿé¢„è®¾
  name           String             // å‹‹ç« åç§°
  description    String             // æè¿°/è§£é”æ¡ä»¶è¯´æ˜
  icon           String             // å›¾æ ‡åç§°
  color          String             // é¢œè‰²
  
  // è§£é”æ¡ä»¶
  conditionType  String             // æ¡ä»¶ç±»å‹
  conditionValue Int                // æ¡ä»¶å€¼
  
  isSystem       Boolean  @default(false)  // æ˜¯å¦ç³»ç»Ÿé¢„è®¾
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // å…³è”
  child               Child?                @relation(fields: [childId], references: [id], onDelete: Cascade)
  unlockedAchievements UnlockedAchievement[]
  
  @@index([isSystem])
  @@index([conditionType])
  @@map("achievements")
}

/// å·²è§£é”æˆå°±è¡¨
model UnlockedAchievement {
  id            String   @id @default(cuid())
  childId       String
  achievementId String
  unlockedAt    DateTime @default(now())
  
  // å…³è”
  child       Child       @relation(fields: [childId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([childId, achievementId])
  @@index([childId])
  @@map("unlocked_achievements")
}

// ==================== ç§¯åˆ†å¥–åŠ±ç³»ç»Ÿ ====================

/// å¥–åŠ±è¡¨ï¼ˆå®¶é•¿è®¾ç½®ï¼‰
model Reward {
  id          String   @id @default(cuid())
  userId      String             // æ‰€å±ç”¨æˆ·
  name        String             // å¥–åŠ±åç§°
  description String?            // æè¿°
  pointsCost  Int                // æ‰€éœ€ç§¯åˆ†
  icon        String   @default("gift")  // å›¾æ ‡
  stock       Int?               // åº“å­˜ï¼Œnullè¡¨ç¤ºæ— é™
  isActive    Boolean  @default(true)    // æ˜¯å¦å¯ç”¨
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // å…³è”
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  redemptions RewardRedemption[]
  
  @@index([userId])
  @@index([isActive])
  @@map("rewards")
}

/// å¥–åŠ±å…‘æ¢è®°å½•è¡¨
model RewardRedemption {
  id          String   @id @default(cuid())
  childId     String
  rewardId    String
  pointsSpent Int                // èŠ±è´¹ç§¯åˆ†
  
  // çŠ¶æ€
  status      String   @default("pending")
  // pending: å¾…å…‘ç°
  // fulfilled: å·²å…‘ç°
  // cancelled: å·²å–æ¶ˆ
  
  redeemedAt  DateTime @default(now())  // å…‘æ¢æ—¶é—´
  fulfilledAt DateTime?          // å…‘ç°æ—¶é—´
  
  // å…³è”
  child  Child  @relation(fields: [childId], references: [id], onDelete: Cascade)
  reward Reward @relation(fields: [rewardId], references: [id])
  
  @@index([childId])
  @@index([status])
  @@map("reward_redemptions")
}

/// ç§¯åˆ†å˜åŠ¨æ—¥å¿—è¡¨
model PointsLog {
  id        String   @id @default(cuid())
  childId   String
  type      String             // earn: è·å¾—, spend: æ¶ˆè´¹, penalty: æƒ©ç½š
  amount    Int                // å˜åŠ¨æ•°é‡(æ­£æ•°)
  reason    String             // åŸå› è¯´æ˜
  relatedId String?            // å…³è”IDï¼ˆä»»åŠ¡/å¥–åŠ±ï¼‰
  
  createdAt DateTime @default(now())
  
  // å…³è”
  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  @@index([childId])
  @@index([type])
  @@index([createdAt])
  @@map("points_logs")
}

// ==================== æˆç»©è¿½è¸ª ====================

/// è€ƒè¯•æˆç»©è¡¨
model ExamRecord {
  id           String   @id @default(cuid())
  childId      String
  
  // åŸºç¡€ä¿¡æ¯
  academicYear Int                // å­¦å¹´ï¼Œå¦‚2025
  grade        Int                // å¹´çº§ 1-6
  semester     String             // å­¦æœŸ first/second
  
  // è€ƒè¯•ä¿¡æ¯
  examDate     String             // è€ƒè¯•æ—¥æœŸ YYYY-MM-DD
  examName     String             // è€ƒè¯•åç§°
  examType     String             // è€ƒè¯•ç±»å‹
  
  // æˆç»©ä¿¡æ¯
  subjectId    String
  totalScore   Int?     @default(100)  // æ»¡åˆ†
  score        Int                // å¾—åˆ†
  targetScore  Int?               // ç›®æ ‡åˆ†
  classAverage Float?             // ç­çº§å¹³å‡åˆ†
  classMax     Int?               // ç­çº§æœ€é«˜åˆ†
  classMedian  Float?             // ç­çº§ä¸­ä½æ•°
  performance  String?            // è€ƒè¯•è¡¨ç°
  
  // æ’åä¿¡æ¯ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
  rankings     Json?              // [{type: "class", rank: 5}, {type: "grade", rank: 20}]
  
  // è–„å¼±åˆ†æï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
  weaknesses   Json?              // [{questionType, knowledgePoint, totalPoints, earnedPoints}]
  
  summary      String?            // æ€»ç»“
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // å…³è”
  child   Child   @relation(fields: [childId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id])
  
  @@index([childId])
  @@index([subjectId])
  @@index([examDate])
  @@map("exam_records")
}
```

---

## äºŒã€æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  (ç”¨æˆ·è¡¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1:N
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Child     â”‚ N:1   â”‚   Reward    â”‚
â”‚ (å°å­©æ¡£æ¡ˆ)  â”‚â—„â”€â”€â”€â”€â”€â”€â”‚  (å¥–åŠ±è¡¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚ 1:N                 â”‚ 1:N
       â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚TaskTemplate  â”‚  â”‚ StudyPlan    â”‚                â”‚
â”‚  â”‚  (ä»»åŠ¡æ¨¡æ¿)  â”‚  â”‚  (å­¦ä¹ è®¡åˆ’)  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                 â”‚                         â”‚
â”‚         â”‚ N:1             â”‚ 1:N                     â”‚
â”‚         â–¼                 â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   Subject    â”‚  â”‚CheckInRecord â”‚                â”‚
â”‚  â”‚   (ç§‘ç›®è¡¨)   â”‚  â”‚  (æ‰“å¡è®°å½•)  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Achievement  â”‚  â”‚  ExamRecord  â”‚                â”‚
â”‚  â”‚  (æˆå°±è¡¨)    â”‚  â”‚  (æˆç»©è¡¨)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                                           â”‚
â”‚         â”‚ 1:N                                       â”‚
â”‚         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚Unlocked      â”‚  â”‚RewardRedemptionâ”‚              â”‚
â”‚  â”‚Achievement   â”‚  â”‚ (å¥–åŠ±å…‘æ¢)   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  PointsLog   â”‚                                  â”‚
â”‚  â”‚  (ç§¯åˆ†æ—¥å¿—)  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€ç´¢å¼•è®¾è®¡è¯´æ˜

### 3.1 ä¸»è¦æŸ¥è¯¢åœºæ™¯ä¸ç´¢å¼•

| æŸ¥è¯¢åœºæ™¯ | æ¶‰åŠè¡¨ | ç´¢å¼•å­—æ®µ |
|----------|--------|----------|
| è·å–ç”¨æˆ·æ‰€æœ‰å°å­© | children | userId |
| è·å–å°å­©çš„ä»»åŠ¡æ¨¡æ¿ | task_templates | childId, subjectId |
| è·å–æŸæ—¥æœŸèŒƒå›´çš„è®¡åˆ’ | study_plans | childId, startDate, endDate |
| è·å–æŸå¤©çš„æ‰“å¡è®°å½• | check_in_records | childId, date |
| æŒ‰çŠ¶æ€ç­›é€‰æ‰“å¡ | check_in_records | status |
| è·å–ç³»ç»Ÿæˆå°± | achievements | isSystem |
| è·å–å·²è§£é”æˆå°± | unlocked_achievements | childId |
| è·å–å¯ç”¨å¥–åŠ± | rewards | userId, isActive |
| è·å–ç§¯åˆ†å†å² | points_logs | childId, createdAt |
| è·å–æˆç»©è®°å½• | exam_records | childId, examDate |

### 3.2 å¤åˆç´¢å¼•ä¼˜åŒ–

```prisma
// æ‰“å¡è®°å½•çš„å¸¸ç”¨æŸ¥è¯¢
@@index([childId, date])           // æŸ¥è¯¢æŸä¸ªå°å­©æŸå¤©çš„è®°å½•
@@index([childId, status, date])   // æŸ¥è¯¢æŸä¸ªå°å­©æŸçŠ¶æ€çš„è®°å½•

// å­¦ä¹ è®¡åˆ’çš„æ—¥æœŸèŒƒå›´æŸ¥è¯¢
@@index([childId, startDate, endDate, isDeleted])

// ç§¯åˆ†æ—¥å¿—çš„æ—¶é—´èŒƒå›´æŸ¥è¯¢
@@index([childId, createdAt])
@@index([childId, type, createdAt])
```

---

## å››ã€æ•°æ®è¿ç§»è„šæœ¬

### 4.1 åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®...');

  // 1. åˆ›å»ºç³»ç»Ÿç§‘ç›®
  const subjects = [
    { id: 'subj_yuwen', name: 'è¯­æ–‡', icon: 'ğŸ“–', color: '#4A90D9', isSystem: true, sortOrder: 1 },
    { id: 'subj_shuxue', name: 'æ•°å­¦', icon: 'ğŸ”¢', color: '#5CB85C', isSystem: true, sortOrder: 2 },
    { id: 'subj_yingyu', name: 'è‹±è¯­', icon: 'ğŸ”¤', color: '#F0AD4E', isSystem: true, sortOrder: 3 },
    { id: 'subj_wuli', name: 'ç‰©ç†', icon: 'âš›ï¸', color: '#9B59B6', isSystem: true, sortOrder: 4 },
    { id: 'subj_huaxue', name: 'åŒ–å­¦', icon: 'ğŸ§ª', color: '#E74C3C', isSystem: true, sortOrder: 5 },
    { id: 'subj_shengwu', name: 'ç”Ÿç‰©', icon: 'ğŸŒ±', color: '#27AE60', isSystem: true, sortOrder: 6 },
    { id: 'subj_dili', name: 'åœ°ç†', icon: 'ğŸŒ', color: '#3498DB', isSystem: true, sortOrder: 7 },
    { id: 'subj_lishi', name: 'å†å²', icon: 'ğŸ“œ', color: '#8B4513', isSystem: true, sortOrder: 8 },
    { id: 'subj_daofa', name: 'é“æ³•', icon: 'âš–ï¸', color: '#E91E63', isSystem: true, sortOrder: 9 },
    { id: 'subj_kexue', name: 'ç§‘å­¦', icon: 'ğŸ”¬', color: '#00BCD4', isSystem: true, sortOrder: 10 },
    { id: 'subj_yundong', name: 'è¿åŠ¨', icon: 'ğŸƒ', color: '#FF5722', isSystem: true, sortOrder: 11 },
    { id: 'subj_jineng', name: 'æŠ€èƒ½', icon: 'ğŸ’¡', color: '#607D8B', isSystem: true, sortOrder: 12 },
    { id: 'subj_jianshi', name: 'è§è¯†', icon: 'ğŸŒ', color: '#795548', isSystem: true, sortOrder: 13 },
  ];

  for (const subject of subjects) {
    await prisma.subject.upsert({
      where: { id: subject.id },
      update: subject,
      create: subject,
    });
  }
  console.log(`âœ… åˆ›å»ºäº† ${subjects.length} ä¸ªç³»ç»Ÿç§‘ç›®`);

  // 2. åˆ›å»ºç³»ç»Ÿæˆå°±
  const achievements = [
    // åšæŒç³»åˆ—
    { id: 'ach_3days', name: 'åˆè¯•ç‰›åˆ€', description: 'è¿ç»­æ‰“å¡3å¤©', icon: 'flame', color: '#FF6B6B', conditionType: 'consecutive_days', conditionValue: 3, isSystem: true },
    { id: 'ach_7days', name: 'æ¸å…¥ä½³å¢ƒ', description: 'è¿ç»­æ‰“å¡7å¤©', icon: 'star', color: '#FFD93D', conditionType: 'consecutive_days', conditionValue: 7, isSystem: true },
    { id: 'ach_30days', name: 'æŒä¹‹ä»¥æ’', description: 'è¿ç»­æ‰“å¡30å¤©', icon: 'muscle', color: '#6BCB77', conditionType: 'consecutive_days', conditionValue: 30, isSystem: true },
    { id: 'ach_100days', name: 'å­¦ä¹ ä¹‹ç‹', description: 'è¿ç»­æ‰“å¡100å¤©', icon: 'crown', color: '#9B59B6', conditionType: 'consecutive_days', conditionValue: 100, isSystem: true },
    // æ—¶é•¿ç³»åˆ—
    { id: 'ach_10hours', name: 'èµ·æ­¥é˜¶æ®µ', description: 'ç´¯è®¡å­¦ä¹ 10å°æ—¶', icon: 'clock', color: '#74B9FF', conditionType: 'total_study_hours', conditionValue: 10, isSystem: true },
    { id: 'ach_50hours', name: 'å‹¤å¥‹å¥½å­¦', description: 'ç´¯è®¡å­¦ä¹ 50å°æ—¶', icon: 'book-open', color: '#A29BFE', conditionType: 'total_study_hours', conditionValue: 50, isSystem: true },
    { id: 'ach_100hours', name: 'å­¦éœ¸å…»æˆ', description: 'ç´¯è®¡å­¦ä¹ 100å°æ—¶', icon: 'graduation-cap', color: '#FD79A8', conditionType: 'total_study_hours', conditionValue: 100, isSystem: true },
    { id: 'ach_500hours', name: 'å­¦ç¥é™ä¸´', description: 'ç´¯è®¡å­¦ä¹ 500å°æ—¶', icon: 'trophy', color: '#FDCB6E', conditionType: 'total_study_hours', conditionValue: 500, isSystem: true },
    // ä»»åŠ¡ç³»åˆ—
    { id: 'ach_50tasks', name: 'ä»»åŠ¡æ–°æ‰‹', description: 'ç´¯è®¡å®Œæˆ50ä¸ªä»»åŠ¡', icon: 'check-circle', color: '#00CEC9', conditionType: 'total_tasks', conditionValue: 50, isSystem: true },
    { id: 'ach_200tasks', name: 'ä»»åŠ¡è¾¾äºº', description: 'ç´¯è®¡å®Œæˆ200ä¸ªä»»åŠ¡', icon: 'check-square', color: '#6C5CE7', conditionType: 'total_tasks', conditionValue: 200, isSystem: true },
    { id: 'ach_1000tasks', name: 'ä»»åŠ¡å¤§å¸ˆ', description: 'ç´¯è®¡å®Œæˆ1000ä¸ªä»»åŠ¡', icon: 'award', color: '#E17055', conditionType: 'total_tasks', conditionValue: 1000, isSystem: true },
    // ç‰¹æ®Šæˆå°±
    { id: 'ach_early_bird', name: 'æ—©èµ·é¸Ÿ', description: 'æ—©ä¸Š7ç‚¹å‰æ‰“å¡10æ¬¡', icon: 'sunrise', color: '#FF9F43', conditionType: 'early_bird', conditionValue: 10, isSystem: true },
    { id: 'ach_perfect_week', name: 'å®Œç¾ä¸€å‘¨', description: 'è¿ç»­7å¤©100%å®Œæˆç‡', icon: 'target', color: '#00D2D3', conditionType: 'perfect_days', conditionValue: 7, isSystem: true },
    { id: 'ach_perfect_month', name: 'å®Œç¾ä¸€æœˆ', description: 'è¿ç»­30å¤©100%å®Œæˆç‡', icon: 'zap', color: '#F368E0', conditionType: 'perfect_days', conditionValue: 30, isSystem: true },
  ];

  for (const achievement of achievements) {
    await prisma.achievement.upsert({
      where: { id: achievement.id },
      update: achievement,
      create: achievement,
    });
  }
  console.log(`âœ… åˆ›å»ºäº† ${achievements.length} ä¸ªç³»ç»Ÿæˆå°±`);

  console.log('ğŸ‰ ç³»ç»Ÿæ•°æ®åˆå§‹åŒ–å®Œæˆï¼');
}

main()
  .catch((e) => {
    console.error('åˆå§‹åŒ–å¤±è´¥:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### 4.2 package.json é…ç½®

```json
{
  "prisma": {
    "seed": "ts-node prisma/seed.ts"
  }
}
```

### 4.3 è¿è¡Œè¿ç§»

```bash
# åˆ›å»ºè¿ç§»
npx prisma migrate dev --name init

# è¿è¡Œç§å­æ•°æ®
npx prisma db seed

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
npx prisma migrate deploy
```

---

## äº”ã€æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 5.1 å¤‡ä»½ç­–ç•¥

Railway PostgreSQL æä¾›è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½ï¼Œä½†å»ºè®®é¢å¤–å®ç°ï¼š

```typescript
// src/services/backupService.ts
import { prisma } from '../prisma';

export const backupService = {
  // å¯¼å‡ºç”¨æˆ·æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºæ•°æ®è¿ç§»ï¼‰
  async exportUserData(userId: string) {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: {
        children: {
          include: {
            taskTemplates: true,
            studyPlans: true,
            checkInRecords: true,
            unlockedAchievements: true,
            rewardRedemptions: true,
            examRecords: true,
            pointsLogs: true,
          },
        },
        rewards: true,
      },
    });

    return user;
  },

  // å¯¼å…¥ç”¨æˆ·æ•°æ®
  async importUserData(data: any) {
    // ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§
    await prisma.$transaction(async (tx) => {
      // æŒ‰é¡ºåºå¯¼å…¥å„è¡¨æ•°æ®
      // ...
    });
  },
};
```

### 5.2 æ•°æ®ä¿ç•™ç­–ç•¥

```typescript
// å®šæœŸæ¸…ç†ä»»åŠ¡ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦é™åˆ¶æ•°æ®é‡ï¼‰
// ä½†æ ¹æ®éœ€æ±‚ï¼Œä¿ç•™6å¹´æ•°æ®ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸éœ€è¦æ¸…ç†

// å¦‚æœæœªæ¥éœ€è¦å½’æ¡£æ—§æ•°æ®
export const archiveService = {
  // å½’æ¡£è¶…è¿‡6å¹´çš„æ•°æ®
  async archiveOldData() {
    const sixYearsAgo = new Date();
    sixYearsAgo.setFullYear(sixYearsAgo.getFullYear() - 6);

    // å¯¼å‡ºæ—§æ•°æ®åˆ°å½’æ¡£å­˜å‚¨
    // åˆ é™¤æ•°æ®åº“ä¸­çš„æ—§æ•°æ®
  },
};
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨selectåªè·å–éœ€è¦çš„å­—æ®µ
const plans = await prisma.studyPlan.findMany({
  where: { childId, isDeleted: false },
  select: {
    id: true,
    name: true,
    subjectId: true,
    startDate: true,
    endDate: true,
    // ä¸éœ€è¦çš„å­—æ®µä¸æŸ¥è¯¢
  },
});

// ä½¿ç”¨åˆ†é¡µ
const records = await prisma.checkInRecord.findMany({
  where: { childId },
  orderBy: { date: 'desc' },
  take: 50,
  skip: page * 50,
});

// ä½¿ç”¨countä»£æ›¿è·å–å…¨éƒ¨æ•°æ®
const totalTasks = await prisma.checkInRecord.count({
  where: {
    childId,
    status: { in: ['completed', 'auto_completed', 'manual_completed'] },
  },
});
```

### 6.2 æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡åˆ›å»ºæ‰“å¡è®°å½•ï¼ˆç”Ÿæˆé‡å¤è®¡åˆ’æ—¶ï¼‰
await prisma.checkInRecord.createMany({
  data: records,
  skipDuplicates: true,
});

// æ‰¹é‡æ›´æ–°çŠ¶æ€
await prisma.checkInRecord.updateMany({
  where: {
    childId,
    date: today,
    status: 'pending',
  },
  data: {
    status: 'missed',
  },
});
```

### 6.3 è¿æ¥æ± é…ç½®

```typescript
// åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½®è¿æ¥æ± 
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  // Railwayè‡ªåŠ¨ç®¡ç†è¿æ¥æ± 
});
```

