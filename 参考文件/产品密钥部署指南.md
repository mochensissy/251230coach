# 产品密钥系统与部署指南

这份文档详细说明了如何使用新开发的产品密钥系统，以及如何将应用部署到 Railway 平台。

## 第一部分：产品密钥系统使用说明

### 1. 功能概述
- **注册保护**：新用户注册时必须输入有效的"产品密钥"。
- **一次性使用**：密钥一旦被使用，状态会变为 `used`，且绑定到该用户，无法再次使用。
- **后台生成**：目前提供了管理员 API 来批量生成密钥。

### 2. 如何生成密钥 (管理员)
你需要使用 API 工具 (如 Postman, Apifox 或 curl) 调用生成接口。

- **接口地址**: `POST /api/admin/keys/generate` (本地调试通常是 `http://localhost:3000/api/admin/keys/generate`)
- **公网地址**: 部署后，请将 `localhost:3000` 替换为 Railway 提供的域名 (例如 `https://your-app.up.railway.app`)
- **Headers**:
  - `Content-Type`: `application/json`
  - `Authorization`: `Bearer <你的管理员Token>` (目前的简单实现只检查是否登录用户)
- **Body (JSON)**:
  ```json
  {
    "count": 5,
    "batch": "第一批内测卡"
  }
  ```
- **成功响应**: 会返回生成的 5 个密钥。

### 3. 如何查看密钥列表
- **接口地址**: `GET /api/admin/keys/list`

---

## 第二部分：Railway 部署详细教程 (保姆级)

我已经为你准备好了部署所需的基础代码配置（包括 `package.json` 和静态文件服务配置）。现在你只需要按照以下步骤操作：

### 第一步：准备代码 (Push to GitHub)
1. 确保你所有的代码都已经提交并推送到你的 GitHub 仓库。
   - 确保 `railway.json` 和根目录的 `package.json` 都在仓库中。

### 第二步：注册并连接 Railway
1. 打开 [Railway.app](https://railway.app/)。
2. 点击 "Login" -> 选择 "GitHub" 进行登录授权。

### 第三步：创建项目
1. 登录后，点击右上角的 **"New Project"**。
2. 选择 **"Deploy from GitHub repo"**。
3. 从列表中选择你的仓库 `studygrow-tracker` (或者你的仓库名)。
4. 点击 **"Deploy Now"** (或者如果它询问配置，可以先暂缓，稍后配置变量)。

### 第四步：添加数据库
1. 在项目视图中，按下 `Ctrl + K` 或者点击 "New" 按钮。
2. 搜索并选择 **"Database"** -> **"PostgreSQL"**。
3. 等待几十秒，Railway 会创建一个数据库服务。

### 第五步：配置环境变量 (关键!)
1. 点击你的应用服务卡片 (就是显示你 GitHub 仓库名的那个)。
2. 进入 **"Variables"** 选项卡。
3. 点击 **"New Variable"**，添加以下变量：

| 变量名 | 值 / 说明 |
| :--- | :--- |
| `DATABASE_URL` | 输入 `${{Postgres.DATABASE_URL}}` (Railway 会自动补全并链接到刚才创建的数据库) |
| `JWT_SECRET` | 随便输入一段很长的乱码字符串 (用于加密 Token) |
| `CLIENT_URL` | 前端访问地址，例如 `https://your-frontend.railway.app` (用于跨域 CORS 配置，必须与前端实际地址一致) |
| `JWT_EXPIRES_IN` | 登录过期时间，默认为 `30d` (30天)，可自定义如 `7d`, `24h` 等 |
| `NODE_ENV` | `production` |
| `PORT` | `3000` |

### 第六步：验证部署
1. 添加完变量后，Railway 通常会自动触发重新部署。
2. 观察 "Deployments" 选项卡，等待部署状态变为 **"Success"** (绿色)。
3. 如果部署失败，点击去查看 Logs (日志) 排查问题。
4. 部署成功后，Railway 会生成一个公网域名 (例如 `xxx.up.railway.app`)。
5. 点击该链接，你应该能看到你的应用界面！

### 第七步：初始化数据库 (生产环境)
部署成功且应用启动后，第一次可能需要初始化数据库表结构。
通常 `package.json` 中的 `start` 命令可以在启动前运行迁移，但为了稳妥，你可以：
1. 在本地终端，通过修改 `.env` 里的 `DATABASE_URL` 指向 Railway 的数据库地址 (可以在 Railway 数据库服务的 "Connect" 选项卡找到)，然后运行 `npx prisma migrate deploy`。
2. 或者，在 Railway 的应用服务中，设置 Start Command 为 `npx prisma migrate deploy && npm start --prefix server` (需要确保 migrate 能在生产环境运行)。
   - **推荐简单做法**: 我已经在本地生成了 migration 文件。只要连接上同一个数据库，Prisma 在启动时如果配置得当会自动尝试同步（视配置而定）。
   - **最稳妥做法**: 在 Railway 该服务的 **Settings -> Build** 中，将 Build Command 修改为:
     `npm run build && cd server && npx prisma migrate deploy`
     这样每次部署都会自动更新数据库结构。

---

**遇到问题怎么办？**
- 检查 Logs：Railway 的日志非常详细，报错通常会告诉你缺什么。
- 权限问题：确保存储库是 Public 或者 Railway 有权限访问 Private 仓库。

---

## 第三部分：后台用户管理系统 (新功能)

除了产品密钥，系统现在还支持简单的后台用户管理功能。

### 1. 如何获得管理员权限
无需手动修改数据库，也无需专门的管理员账号。
1.  **设置环境变量**: 在 Railway 项目的 "Variables" 中，添加一个名为 `ADMIN_EMAIL` 的变量。
2.  **赋值**: 将其值设置为你用来注册或登录的邮箱地址 (例如 `boss@example.com`)。
3.  **生效**: 当你使用该邮箱注册或登录时，系统会自动识别并赋予你 `admin` 权限。

### 2. 管理员功能接口
拥有管理员权限后，你可以调用以下接口：

#### A. 获取所有用户列表
- **接口**: `GET /api/admin/users/list`
- **参数**: `page` (页码, 默认1), `limit` (每页数量, 默认20), `search` (可选, 搜索手机号或邮箱)

#### B. 导出用户全部数据
- **接口**: `GET /api/admin/users/{userId}/export`
- **说明**: 将 `{userId}` 替换为具体的 ID。该接口会返回该用户及其孩子的所有数据 (学习计划、打卡记录、积分、奖励等) 的 JSON 结构，方便备份或迁移。
