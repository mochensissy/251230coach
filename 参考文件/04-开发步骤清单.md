# 开发步骤清单

> ⚠️ **重要提示**: 开始新对话时，请先阅读此文档和 `00-项目总览.md` 了解项目背景

## 开发进度追踪

### 当前状态
- [x] 阶段一：项目初始化 ✅ (2024-12-17 完成)
- [x] 阶段二：用户系统 ✅ (2024-12-18 完成)
- [x] 阶段三：计划模板管理 ✅ (2024-12-18 完成)
- [x] 阶段四：学习计划与打卡 ✅ (2024-12-18 完成)
- [x] 阶段五：同步机制 ✅ (2024-12-18 完成)
- [x] 阶段六：统计分析 ✅ (2024-12-18 完成)
- [x] 阶段七：激励系统 ✅ (2024-12-18 完成)
- [x] 阶段八：成绩追踪 ✅ (2024-12-18 完成)
- [x] 阶段九：PDF导出 ✅ (2024-12-18 完成)
- [ ] 阶段十：移动端优化 ⏳ (下一阶段)
- [ ] 阶段十一：部署上线

---

## 阶段一：项目初始化 (预计1天)

### 1.1 创建项目结构
```bash
# 在项目根目录执行
mkdir -p client server

# 初始化前端项目
cd client
npm create vite@latest . -- --template react-ts
npm install

# 初始化后端项目
cd ../server
npm init -y
```

### 1.2 安装前端依赖
```bash
cd client

# UI框架
npm install tailwindcss postcss autoprefixer
npm install class-variance-authority clsx tailwind-merge

# shadcn/ui (需要手动配置)
npx shadcn-ui@latest init

# 路由和状态管理
npm install react-router-dom zustand @tanstack/react-query

# 本地数据库
npm install dexie dexie-react-hooks

# 表单处理
npm install react-hook-form @hookform/resolvers zod

# 日期处理
npm install date-fns date-fns-tz

# HTTP客户端
npm install axios

# 图表
npm install recharts

# PDF生成
npm install jspdf html2canvas

# 工具库
npm install uuid lodash-es

# 类型定义
npm install -D @types/uuid @types/lodash-es
```

### 1.3 安装后端依赖
```bash
cd server

# 核心依赖
npm install express cors helmet compression morgan dotenv

# 数据库
npm install @prisma/client
npm install -D prisma

# 认证
npm install bcryptjs jsonwebtoken

# 验证
npm install express-validator

# TypeScript
npm install -D typescript ts-node nodemon @types/express @types/cors @types/bcryptjs @types/jsonwebtoken @types/compression @types/morgan
```

### 1.4 配置文件创建

#### 任务清单
- [ ] 创建 `client/tailwind.config.js`
- [ ] 创建 `client/tsconfig.json`
- [ ] 创建 `client/vite.config.ts`
- [ ] 创建 `client/components.json` (shadcn/ui)
- [ ] 创建 `server/tsconfig.json`
- [ ] 创建 `server/prisma/schema.prisma`
- [ ] 创建 `.env.example`
- [ ] 创建 `railway.json`
- [ ] 创建 `.gitignore`

### 1.5 验收标准
- [x] 前端项目能正常启动 (`npm run dev`) ✅
- [x] 后端项目结构创建完成 ✅
- [x] Tailwind CSS 配置完成 ✅
- [x] Prisma Schema 定义完成 ✅
- [x] 基础路由配置完成 ✅
- [x] 登录/注册页面创建完成 ✅
- [x] 主看板页面框架创建完成 ✅

---

## 阶段二：用户系统 (预计2天)

### 2.1 后端 - 用户API

#### 任务清单
- [x] 创建 `server/src/routes/auth.ts` - 认证路由 ✅
- [x] 创建 `server/src/controllers/authController.ts` ✅
- [x] 创建 `server/src/services/authService.ts` ✅
- [x] 创建 `server/src/middleware/auth.ts` - JWT中间件 ✅
- [x] 实现注册接口 `POST /api/auth/register` ✅
- [x] 实现登录接口 `POST /api/auth/login` ✅
- [x] 实现验证家长密码接口 `POST /api/auth/verify-parent` ✅
- [x] 实现获取用户信息接口 `GET /api/auth/me` ✅

#### API设计
```typescript
// POST /api/auth/register
Request: {
  phone?: string;
  email?: string;
  password: string;
  parentPassword: string;
  childName: string;
  childGrade: number;
  childSemester: 'first' | 'second';
}
Response: {
  token: string;
  user: { id, phone, email };
  child: { id, name, grade, semester };
}

// POST /api/auth/login
Request: {
  account: string;  // 手机号或邮箱
  password: string;
}
Response: {
  token: string;
  user: { id, phone, email };
  children: [{ id, name, grade, semester }];
}

// POST /api/auth/verify-parent
Request: {
  parentPassword: string;
}
Response: {
  success: boolean;
}
```

### 2.2 前端 - 本地存储

#### 任务清单
- [x] 创建 `client/src/db/database.ts` - Dexie数据库定义 ✅
- [x] 创建 `client/src/db/repositories/userRepo.ts` ✅
- [x] 创建 `client/src/db/repositories/childRepo.ts` ✅
- [x] 实现本地用户数据存储 ✅
- [x] 实现会话持久化 ✅

### 2.3 前端 - 认证页面

#### 任务清单
- [x] 创建 `client/src/pages/auth/LoginPage.tsx` ✅
- [x] 创建 `client/src/pages/auth/RegisterPage.tsx` ✅
- [x] 创建 `client/src/pages/auth/SelectChildPage.tsx` ✅
- [x] 创建 `client/src/components/auth/ParentModeDialog.tsx` ✅ (家长模式验证弹窗)
- [x] 创建 `client/src/store/authStore.ts` ✅
- [x] 创建 `client/src/hooks/useAuth.ts` ✅
- [x] 创建 `client/src/api/client.ts` - API 客户端 ✅
- [x] 创建 `client/src/api/auth.ts` - 认证 API ✅
- [x] 创建 `client/src/types/index.ts` - 类型定义 ✅
- [x] 实现登录流程 ✅
- [x] 实现注册流程 ✅
- [x] 实现家长模式切换 ✅
- [x] 实现小孩切换 ✅

### 2.4 验收标准
- [x] 能够注册新账号 ✅
- [x] 能够登录已有账号 ✅
- [x] 登录后自动进入小孩模式 ✅
- [x] 能够切换到家长模式（需输入密码）✅
- [x] 能够切换不同小孩 ✅
- [x] 关闭浏览器后重新打开能自动登录 ✅

---

## 阶段三：计划模板管理 (预计2天)

### 3.1 前端 - 科目管理

#### 任务清单
- [x] 创建 `client/src/db/repositories/subjectRepo.ts` ✅
- [x] 创建 `client/src/components/subject/SubjectList.tsx` ✅
- [x] 创建 `client/src/components/subject/SubjectIcon.tsx` ✅
- [x] 实现系统科目初始化 ✅
- [x] 实现科目列表展示 ✅

### 3.2 前端 - 任务模板

#### 任务清单
- [x] 创建 `client/src/db/repositories/templateRepo.ts` ✅
- [x] 创建 `client/src/components/template/TemplateForm.tsx` ✅
- [x] 创建 `client/src/components/template/TemplateCard.tsx` ✅
- [x] 实现添加任务模板 ✅
- [x] 实现编辑任务模板 ✅
- [x] 实现删除任务模板 ✅
- [x] 实现模板列表展示（按科目分组）✅

### 3.3 验收标准
- [x] 左侧显示科目列表（带图标和颜色）✅
- [x] 点击科目展开显示该科目下的任务模板 ✅
- [x] 能够添加新的任务模板 ✅
- [x] 能够编辑已有模板 ✅
- [x] 能够删除模板 ✅
- [x] 模板数据保存在本地IndexedDB ✅

---

## 阶段四：学习计划与打卡 (预计3天)

### 4.1 前端 - 日历视图

#### 任务清单
- [x] 创建 `client/src/components/calendar/WeekView.tsx` ✅
- [x] 实现周视图展示 ✅
- [x] 实现日期切换（前一周/后一周）✅
- [x] 实现"今天"按钮 ✅

### 4.2 前端 - 添加计划

#### 任务清单
- [x] 创建 `client/src/db/repositories/planRepo.ts` ✅
- [x] 创建 `client/src/components/plan/AddPlanDialog.tsx` ✅
- [x] 创建 `client/src/components/ui/TimeSlider.tsx` - **时间滑块组件** ✅
- [x] 实现添加单个计划 ✅
- [x] 实现重复计划生成逻辑 ✅

#### 时间滑块组件设计
```tsx
// TimeSlider.tsx
interface TimeSliderProps {
  value: number;           // 当前值（分钟）
  onChange: (value: number) => void;
  min?: number;            // 最小值，默认5
  max?: number;            // 最大值，默认120
  step?: number;           // 步进，默认5
  presets?: number[];      // 预设值 [15, 30, 45, 60, 90]
}

// 使用 @radix-ui/react-slider 实现
```

### 4.3 前端 - 打卡功能

#### 任务清单
- [x] 创建 `client/src/db/repositories/checkInRepo.ts` ✅
- [x] 创建 `client/src/components/checkin/TaskCard.tsx` ✅
- [x] 创建 `client/src/components/checkin/SummaryDialog.tsx` ✅
- [x] 创建 `client/src/hooks/useTimer.ts` ✅
- [x] 实现计时器功能（开始/暂停/结束）✅
- [x] 实现打卡记录保存 ✅
- [x] 实现学习总结弹窗 ✅
- [x] 实现手动完成功能 ✅

### 4.4 前端 - 主看板

#### 任务清单
- [x] 更新 `client/src/pages/child/DashboardPage.tsx` ✅
- [x] 实现顶部统计栏 ✅
- [x] 实现任务列表展示 ✅
- [x] 实现任务状态颜色区分 ✅

### 4.5 验收标准
- [x] 日历视图正确显示当前周 ✅
- [x] 能够切换周 ✅
- [x] 能够添加计划（单个）✅
- [x] 时间滑块能正常拖动设置时长 ✅
- [x] 能够开始/暂停/结束计时 ✅
- [x] 打卡完成后记录保存到本地 ✅
- [x] 任务状态颜色正确显示 ✅
- [x] 顶部统计数据实时更新 ✅

---

## 阶段五：同步机制 (预计2天)

### 5.1 后端 - 同步API

#### 任务清单
- [x] 创建 `server/src/routes/sync.ts` ✅
- [x] 创建 `server/src/controllers/syncController.ts` ✅
- [x] 创建 `server/src/services/syncService.ts` ✅
- [x] 实现同步接口 `POST /api/sync` ✅
- [x] 实现初始数据接口 `GET /api/sync/initial` ✅
- [x] 实现冲突检测逻辑（使用最新时间戳优先）✅
- [x] 实现增量同步逻辑 ✅

### 5.2 前端 - 同步功能

#### 任务清单
- [x] 创建 `client/src/store/syncStore.ts` ✅
- [x] 创建 `client/src/hooks/useSync.ts` ✅
- [x] 创建 `client/src/components/common/SyncButton.tsx` ✅
- [x] 创建 `client/src/api/sync.ts` ✅
- [x] 实现同步状态管理 ✅
- [x] 实现手动同步触发 ✅
- [x] 实现同步状态显示 ✅
- [x] 实现离线检测 ✅

### 5.3 验收标准
- [x] 点击同步按钮能上传本地更改 ✅
- [x] 同步后能下载服务器更新 ✅
- [x] 同步状态正确显示（已同步/有更改/同步中/失败）✅
- [x] 离线时能正常使用 ✅
- [x] 多设备数据能正确同步 ✅

---

## 阶段六：统计分析 (预计2天)

### 6.1 前端 - 统计计算

#### 任务清单
- [x] 创建 `client/src/hooks/useStats.ts` ✅
- [x] 创建 `client/src/utils/stats.ts` ✅
- [x] 实现今日学习时间计算 ✅
- [x] 实现任务完成率计算 ✅
- [x] 实现连续打卡天数计算 ✅
- [x] 实现各科目时间统计 ✅
- [x] 实现学习专注度计算 ✅

### 6.2 前端 - 图表组件

#### 任务清单
- [x] 创建 `client/src/pages/child/StatsPage.tsx` ✅
- [x] 创建 `client/src/components/charts/CompletionChart.tsx` - 每日完成情况 ✅
- [x] 创建 `client/src/components/charts/TimeChart.tsx` - 学习时间趋势 ✅
- [x] 创建 `client/src/components/charts/SubjectPieChart.tsx` - 科目占比 ✅
- [x] 创建 `client/src/components/charts/CompletionTypeChart.tsx` - 完成类型分布 ✅
- [x] 实现日期范围筛选（周切换）✅

### 6.3 验收标准
- [x] 顶部统计栏数据准确 ✅
- [x] 各图表正确渲染 ✅
- [x] 日期筛选功能正常 ✅
- [x] 图表数据与打卡记录一致 ✅
- [x] 移动端图表能正常显示 ✅

---

## 阶段七：激励系统 (预计2天)

### 7.1 前端 - 积分系统

#### 任务清单
- [x] 创建 `client/src/db/repositories/pointsRepo.ts` ✅
- [x] 实现积分计算逻辑 ✅
- [x] 实现积分日志记录 ✅
- [x] 实现当前积分查询 ✅

### 7.2 前端 - 勋章系统

#### 任务清单
- [x] 创建 `client/src/db/repositories/achievementRepo.ts` ✅
- [x] 创建 `client/src/pages/child/AchievementsPage.tsx` ✅
- [x] 创建 `client/src/components/achievement/AchievementCard.tsx` ✅
- [x] 实现勋章墙展示 ✅
- [x] 实现成就详情弹窗 ✅

### 7.3 前端 - 奖励系统

#### 任务清单
- [x] 创建 `client/src/db/repositories/rewardRepo.ts` ✅
- [x] 创建 `client/src/pages/child/RewardsPage.tsx` ✅
- [x] 创建 `client/src/components/reward/RewardCard.tsx` ✅
- [x] 创建 `client/src/components/reward/RewardForm.tsx` ✅
- [x] 实现奖励池展示 ✅
- [x] 实现奖励兑换 ✅
- [x] 实现家长端奖励管理（家长模式）✅

### 7.4 验收标准
- [x] 完成任务后积分正确增加 ✅
- [x] 未完成任务积分正确扣除 ✅
- [x] 勋章墙正确显示已解锁/未解锁 ✅
- [x] 能够兑换奖励 ✅
- [x] 家长能够管理奖励池 ✅

---

## 阶段八：成绩追踪 (预计1天)

### 8.1 前端 - 成绩录入

#### 任务清单
- [x] 创建 `client/src/db/repositories/examRepo.ts` ✅
- [x] 创建 `client/src/components/score/ScoreForm.tsx` ✅
- [x] 创建 `client/src/components/score/ScoreCard.tsx` ✅
- [x] 实现成绩录入表单 ✅
- [x] 实现薄弱点记录 ✅

### 8.2 前端 - 成绩分析

#### 任务清单
- [x] 创建 `client/src/pages/child/ScoresPage.tsx` ✅
- [x] 创建 `client/src/components/score/ScoreTrendChart.tsx` ✅
- [x] 创建 `client/src/components/score/SubjectRadarChart.tsx` ✅
- [x] 实现成绩趋势图 ✅
- [x] 实现各科对比雷达图 ✅
- [x] 实现成绩列表 ✅

### 8.3 验收标准
- [x] 能够录入考试成绩 ✅
- [x] 能够记录薄弱点 ✅
- [x] 成绩趋势图正确显示 ✅
- [x] 各科对比图正确显示 ✅
- [x] 进步/退步标识正确 ✅

---

## 阶段九：PDF导出 (预计1天)

### 9.1 前端 - PDF生成

#### 任务清单
- [ ] 创建 `client/src/utils/pdf.ts`
- [ ] 创建 `client/src/pages/parent/ReportExport.tsx`
- [ ] 创建 `client/src/components/report/ReportPreview.tsx`
- [ ] 创建 `client/src/components/report/ReportCover.tsx`
- [ ] 实现报告封面生成
- [ ] 实现统计图表截图
- [ ] 实现PDF组装
- [ ] 实现下载功能

### 9.2 验收标准
- [ ] 能够选择报告时间范围
- [ ] 能够预览报告内容
- [ ] 能够生成PDF文件
- [ ] PDF内容完整清晰
- [ ] 图表在PDF中正确显示

---

## 阶段十：移动端优化 (预计1天)

### 10.1 响应式布局

#### 任务清单
- [ ] 创建 `client/src/components/layout/BottomNav.tsx`
- [ ] 优化 `MainLayout.tsx` 响应式
- [ ] 优化所有表单组件移动端显示
- [ ] 优化图表组件移动端显示
- [ ] 实现触摸手势支持

### 10.2 PWA配置

#### 任务清单
- [ ] 配置 `vite-plugin-pwa`
- [ ] 创建 `manifest.json`
- [ ] 创建PWA图标
- [ ] 配置Service Worker
- [ ] 测试离线功能

### 10.3 验收标准
- [ ] 手机端布局正常
- [ ] 底部导航正常工作
- [ ] 表单在手机上易于操作
- [ ] 图表在手机上清晰可见
- [ ] 能够添加到主屏幕
- [ ] 离线时能正常使用

---

## 阶段十一：部署上线 (预计1天)

### 11.1 Railway部署

#### 任务清单
- [ ] 创建Railway项目
- [ ] 添加PostgreSQL服务
- [ ] 配置环境变量
- [ ] 部署后端服务
- [ ] 运行数据库迁移
- [ ] 部署前端（或使用Vercel）
- [ ] 配置自定义域名（可选）

### 11.2 测试验收

#### 任务清单
- [ ] 测试注册登录流程
- [ ] 测试计划添加和打卡
- [ ] 测试数据同步
- [ ] 测试统计图表
- [ ] 测试勋章和奖励
- [ ] 测试成绩录入
- [ ] 测试PDF导出
- [ ] 测试移动端体验
- [ ] 性能测试

### 11.3 验收标准
- [ ] 所有功能正常运行
- [ ] 数据同步稳定
- [ ] 页面加载速度acceptable
- [ ] 无明显Bug
- [ ] 移动端体验良好

---

## 开发注意事项

### 代码规范
1. 使用TypeScript严格模式
2. 组件使用函数式组件 + Hooks
3. 状态管理使用Zustand
4. 表单验证使用Zod
5. 样式使用Tailwind CSS

### Git提交规范
```
feat: 新功能
fix: 修复Bug
docs: 文档更新
style: 样式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

### 测试要点
1. 每个功能完成后进行手动测试
2. 重点测试数据同步逻辑
3. 测试离线使用场景
4. 测试多设备同步场景

---

## 快速恢复上下文

如果你是新开的对话，请按以下步骤恢复上下文：

1. 阅读 `00-项目总览.md` 了解项目背景
2. 阅读本文档查看开发进度
3. 查看已完成的代码文件
4. 继续未完成的任务

### 关键文件位置
- 项目计划: `task/` 目录
- 前端代码: `client/src/`
- 后端代码: `server/src/`
- 数据库Schema: `server/prisma/schema.prisma`
- 环境变量: `.env.example`

