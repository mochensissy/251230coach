# 可复用_技术_激活码机制

## 需求描述
实现通过激活码（License Key / CD Key）来解锁软件的会员功能（Premium）。
*   **生成端（管理员）**：批量生成 16 位随机激活码，设置有效期（如365天）。
*   **消费端（用户）**：输入激活码，验证有效性，激活会员权益。

## 1. 数据库设计 (Admin Sidebar)

### ActivationKeys 表
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `key` | string | 唯一索引，激活码文本 (e.g. `ABCD-1234-EFGH-5678`) |
| `type` | string | 类型 (e.g. `standard_yearly`) |
| `status` | string | `active`(待激活), `used`(已使用), `expired`(过期) |
| `expiryDays` | number | 有效期天数 (e.g. 365) |
| `createdAt` | Date | 生成时间 |
| `usedBy` | string | 关联的 User ID (激活人) |
| `usedAt` | Date | 激活时间 |

## 2. 核心逻辑实现

### 2.1 批量生成算法 (Admin)
使用 `crypto` 或 `uuid` 生成随机字符串，并格式化。

```typescript
// utils/keyGenerator.ts
export function generateKey(): string {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 去掉易混淆字符 I,O,1,0
    let key = '';
    for (let i = 0; i < 16; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    // 格式化为 XXXX-XXXX-XXXX-XXXX
    return key.match(/.{1,4}/g)?.join('-') || key;
}

// 批量生成 API
app.post('/api/admin/keys/generate', async (req, res) => {
    const { count, days } = req.body;
    const keys = [];
    for (let i=0; i<count; i++) {
        keys.push({
            key: generateKey(),
            status: 'active',
            expiryDays: days,
            createdAt: new Date()
        });
    }
    await db.keys.insertMany(keys);
});
```

### 2.2 激活验证逻辑 (Client)
用户输入激活码后，调用 API 进行验证。

```typescript
// 1. 查找 Key
const keyRecord = await db.keys.findOne({ key: inputKey });

// 2. 验证状态
if (!keyRecord) throw new Error("激活码无效");
if (keyRecord.status !== 'active') throw new Error("激活码已被使用或过期");

// 3. 执行激活事务
await db.transaction(async () => {
    // A. 标记 Key 为已使用
    await db.keys.update(keyRecord.id, {
        status: 'used',
        usedBy: userId,
        usedAt: new Date()
    });
    
    // B. 更新用户会员权益
    // 计算会员过期时间：当前时间 + key.expiryDays
    const newExpiry = addDays(new Date(), keyRecord.expiryDays);
    await db.users.update(userId, {
        membershipType: 'premium',
        membershipExpiry: newExpiry
    });
});
```

## 3. 安全性复用建议
1.  **防暴破**：激活接口应增加 Rate Limit（频率限制），例如每IP每分钟限制尝试5次，防止暴力猜解激活码。
2.  **事务一致性**：激活逻辑必须是原子操作，防止“Key被标记为使用但用户未获得权益”或反之。
3.  **日志审计**：记录谁、在什么时间、激活了哪个 Key，便于客诉查询。
