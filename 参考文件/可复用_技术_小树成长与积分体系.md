# å¯å¤ç”¨_æŠ€æœ¯_å°æ ‘æˆé•¿ä¸ç§¯åˆ†å…‘æ¢ä½“ç³»

## éœ€æ±‚æè¿°
å®ç°ä¸€å¥—æ¸¸æˆåŒ–çš„æ¿€åŠ±ä½“ç³»ï¼š
1.  **æœˆåº¦æˆé•¿æ ‘**ï¼šæ ¹æ®å­©å­æ¯æœˆçš„ç´¯ç§¯è·å¾—ç§¯åˆ†ï¼Œè®©æ ‘è‹—ç»å†ä»â€œç§å­â€åˆ°â€œå¤§æ ‘â€çš„äº”ä¸ªé˜¶æ®µå˜åŒ–ã€‚
2.  **ç§¯åˆ†ä½“ç³»**ï¼šè®°å½•ç§¯åˆ†çš„è·å–ï¼ˆä»»åŠ¡å®Œæˆï¼‰ã€æ‰£é™¤ï¼ˆæƒ©ç½šï¼‰å’Œæ¶ˆè´¹ï¼ˆå…‘æ¢å¥–åŠ±ï¼‰ã€‚
3.  **å…‘æ¢ä½“ç³»**ï¼šæ¶ˆè€—å¯ç”¨ç§¯åˆ†å…‘æ¢å®¶é•¿è®¾ç½®çš„å¥–åŠ±ã€‚

## 1. æ ¸å¿ƒæ•°æ®æ¨¡å‹è®¾è®¡

### 1.1 æ ‘çš„æˆé•¿é˜¶æ®µé…ç½®
å®šä¹‰å¸¸é‡é…ç½®ï¼Œæ–¹ä¾¿åç»­è°ƒæ•´æ•°å€¼å’Œé˜¶æ®µã€‚

```typescript
// monthlyTreeRepo.ts
export type TreeStage = 'seed' | 'sprout' | 'seedling' | 'tree' | 'bigtree';

export const TREE_STAGES = [
    { id: 'seed', name: 'ç§å­', minPoints: 0, maxPoints: 0, emoji: 'ğŸ¥œ' },
    { id: 'sprout', name: 'å°èŠ½', minPoints: 1, maxPoints: 100, emoji: 'ğŸŒ±' },
    { id: 'seedling', name: 'å¹¼è‹—', minPoints: 101, maxPoints: 300, emoji: 'ğŸŒ¿' },
    { id: 'tree', name: 'å°æ ‘', minPoints: 301, maxPoints: 600, emoji: 'ğŸŒ³' },
    { id: 'bigtree', name: 'å¤§æ ‘', minPoints: 601, maxPoints: Infinity, emoji: 'ğŸŒ²' },
];

/** æ ¸å¿ƒç®—æ³•ï¼šæ ¹æ®ç§¯åˆ†è®¡ç®—é˜¶æ®µ */
export function calculateTreeStage(points: number): TreeStage {
    // éå†é…ç½®æ‰¾åˆ°å¯¹åº”åŒºé—´
    const stage = TREE_STAGES.find(s => points >= s.minPoints && points <= s.maxPoints);
    return stage ? stage.id : 'bigtree';
}
```

### 1.2 ç§¯åˆ†æ—¥å¿—è¡¨ (PointsLog)
ä¸ç›´æ¥åœ¨ User è¡¨å­˜æ€»åˆ†ï¼Œè€Œæ˜¯é€šè¿‡**æ—¥å¿—è¡¨**è®¡ç®—ï¼Œç¡®ä¿è´¦ç›®å¯è¿½æº¯ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `type` | string | `earn`(è·å¾—), `spend`(æ¶ˆè´¹), `penalty`(æ‰£é™¤), `bonus`(å¥–åŠ±) |
| `amount` | number | å˜åŠ¨æ•°å€¼ï¼ˆå§‹ç»ˆä¸ºæ­£æ•°ï¼‰ |
| `status` | string | `frozen`(å†»ç»“, ä»Šæ—¥è·å¾—æœªç»“ç®—), `available`(å¯ç”¨) |
| `relatedId` | string | å…³è”çš„ä»»åŠ¡/å¥–åŠ± ID |
| `reason` | string | å˜åŠ¨åŸå› æè¿° |

## 2. å…³é”®ä¸šåŠ¡é€»è¾‘å®ç°

### 2.1 ç§¯åˆ†è·å–ä¸æ ‘çš„æˆé•¿è”åŠ¨
æ¯å½“è·å¾—ç§¯åˆ†æ—¶ï¼Œè§¦å‘æ ‘çš„é‡æ–°è®¡ç®—ã€‚

```typescript
// pointsRepo.ts
async function createLog(params) {
    // 1. å†™å…¥ç§¯åˆ†æ—¥å¿—
    await db.pointsLogs.add({ ...params, status: 'frozen' }); // é»˜è®¤ä¸ºå†»ç»“çŠ¶æ€

    // 2. å¦‚æœæ˜¯è·å¾—ç§¯åˆ†ï¼Œè§¦å‘æ ‘çš„æ›´æ–°
    if (params.type === 'earn') {
        // è®¡ç®—æœ¬æœˆç´¯è®¡è·å¾—çš„åˆ†æ•°ï¼ˆåªç®— earnï¼Œä¸ç®— spendï¼‰
        const monthlyPoints = await getMonthlyEarnedPoints(childId);
        const newStage = calculateTreeStage(monthlyPoints);
        
        // æ›´æ–°æœˆåº¦æ ‘è®°å½•
        await db.monthlyTrees.update(treeId, { points: monthlyPoints, stage: newStage });
    }
}
```
**æ³¨æ„ç‚¹**ï¼šæœˆåº¦æ ‘çš„æˆé•¿åªçœ‹â€œ**ç´¯è®¡è·å¾—**â€çš„ç§¯åˆ†ï¼Œä¸åº”è¯¥å› ä¸ºå­©å­å…‘æ¢äº†å¥–åŠ±ï¼ˆæ¶ˆè€—ç§¯åˆ†ï¼‰è€Œå¯¼è‡´æ ‘å˜å°ã€‚

### 2.2 ç§¯åˆ†ç»“ç®—æœºåˆ¶ (é˜²åˆ·åˆ†)
ä¸ºäº†å¢åŠ ä»ªå¼æ„Ÿå¹¶é˜²æ­¢å½“å¤©æ— é™åˆ·åˆ†ï¼Œè®¾è®¡â€œå†»ç»“ç§¯åˆ†â€æœºåˆ¶ã€‚
*   **ä»Šæ—¥è·å¾—**ï¼šçŠ¶æ€ä¸º `frozen`ï¼Œä¸å¯ç”¨äºå…‘æ¢ã€‚
*   **æ¬¡æ—¥ç»“ç®—**ï¼šæ¯å¤©æ‰“å¼€ App æ—¶ï¼Œæ£€æŸ¥æ˜¨æ—¥åŠä¹‹å‰çš„ `frozen` ç§¯åˆ†ï¼Œè½¬æ¢ä¸º `available`ã€‚

```typescript
// pointsRepo.ts -> settlePoints()
async function settlePoints(childId) {
    const today = new Date().setHours(0,0,0,0);
    // æŸ¥æ‰¾ä»Šå¤©ä¹‹å‰çš„æ‰€æœ‰å†»ç»“ç§¯åˆ†
    const frozenLogs = await db.pointsLogs.where({ status: 'frozen', createdAt: { $lt: today } });
    // æ‰¹é‡æ›´æ–°ä¸ºå¯ç”¨
    await db.pointsLogs.bulkUpdate(frozenLogs.map(l => ({ ...l, status: 'available' })));
}
```

### 2.3 ç§¯åˆ†å…‘æ¢ (æ¶ˆè´¹)
å…‘æ¢æ—¶æ‰£é™¤ `available` ç§¯åˆ†ï¼Œä¸ä»…åªæ˜¯å‡æ³•ï¼Œè€Œæ˜¯å¢åŠ ä¸€æ¡ `spend` ç±»å‹çš„æ—¥å¿—ã€‚

```typescript
async function spendPoints(childId, cost, rewardName) {
    const available = await getAvailablePoints(childId);
    if (available < cost) throw new Error("ç§¯åˆ†ä¸è¶³");
    
    // è®°å½•æ¶ˆè´¹æ—¥å¿—
    await createLog({
        type: 'spend',
        amount: cost,
        reason: `å…‘æ¢ï¼š${rewardName}`,
        status: 'available' // æ¶ˆè´¹æ—¥å¿—ç«‹å³ç”Ÿæ•ˆ
    });
}
```

## 3. å‰ç«¯å±•ç¤ºå¤ç”¨
*   **ForestPage**: æ ¹æ® `checkInRepo` æˆ– `monthlyTreeRepo` è·å–å½“å‰çš„ `stage`ï¼ŒåŠ¨æ€æ¸²æŸ“å¯¹åº”å›¾ç‰‡/åŠ¨ç”»ã€‚
*   **å¯è§†åŒ–è¿›åº¦æ¡**: ä½¿ç”¨ `(currentPoints - minPoints) / (maxPoints - minPoints)` è®¡ç®—å½“å‰é˜¶æ®µçš„è¿›åº¦ç™¾åˆ†æ¯”ã€‚
