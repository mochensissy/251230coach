// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "darwin", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. 用户表
model User {
  id                    Int       @id @default(autoincrement())
  username              String    @unique
  password              String    // 密码哈希
  email                 String?
  isAdmin               Boolean   @default(false) // 是否为管理员
  activationCodeId      Int?      // 使用的激活码ID
  role                  String?   // '团队负责人/管理者', '核心骨干/资深专家', '团队成员/执行者'
  businessLine          String?   // '技术/研发', '产品/运营', etc.
  workStyle             String?   // '数据驱动,逻辑严谨', etc.
  developmentGoal       String?
  workChallenge         String?
  onboardingCompleted   Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  sessions              Session[]
  summaryReports        SummaryReport[]
  feedback              Feedback[]
  activationCode        ActivationCode? @relation(fields: [activationCodeId], references: [id])

  @@map("users")
}

// 激活码表
model ActivationCode {
  id          Int       @id @default(autoincrement())
  code        String    @unique // 激活码
  isUsed      Boolean   @default(false) // 是否已使用
  usedBy      Int?      // 使用者ID
  createdBy   String?   // 创建者（管理员用户名）
  note        String?   // 备注
  expiresAt   DateTime? // 过期时间
  usedAt      DateTime? // 使用时间
  createdAt   DateTime  @default(now())

  users       User[]

  @@map("activation_codes")
}

// 2. 对话会话表
model Session {
  id              Int       @id @default(autoincrement())
  userId          Int
  scenario        String    // 'work_problem', 'career_development'
  status          String    @default("in_progress") // 'in_progress', 'completed', 'abandoned'
  currentPhase    String?   // 'goal', 'reality', 'options', 'will'
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMinutes Int?
  messageCount    Int       @default(0)

  user            User      @relation(fields: [userId], references: [id])
  messages        Message[]
  summaryReport   SummaryReport?

  @@map("sessions")
}

// 3. 对话消息表
model Message {
  id            Int       @id @default(autoincrement())
  sessionId     Int
  role          String    // 'user', 'assistant'
  content       String
  phase         String?   // 对应 GROW 的阶段
  hasButtons    Boolean   @default(false)
  buttonOptions String?   // JSON 格式存储按钮选项
  createdAt     DateTime  @default(now())

  session       Session   @relation(fields: [sessionId], references: [id])

  @@map("messages")
}

// 4. 总结报告表
model SummaryReport {
  id            Int       @id @default(autoincrement())
  sessionId     Int       @unique
  userId        Int
  topic         String    // 本次教练议题
  insights      String    // JSON 格式存储关键观察（数组）
  actionPlans   String    // JSON 格式存储行动计划（数组）
  commitment    String?   // 承诺与奖赏
  generatedAt   DateTime  @default(now())

  session       Session   @relation(fields: [sessionId], references: [id])
  user          User      @relation(fields: [userId], references: [id])

  @@map("summary_reports")
}

// 5. 匿名行为分析日志表（用于未来数据看板）
model AnalyticsLog {
  id              Int       @id @default(autoincrement())
  eventType       String    // 'session_start', 'session_complete', 'report_generated', etc.
  scenario        String?   // 场景类型
  phase           String?   // GROW 阶段
  durationSeconds Int?
  metadata        String?   // JSON 格式存储其他分析数据
  createdAt       DateTime  @default(now())

  @@map("analytics_logs")
}

// 6. 用户反馈表
model Feedback {
  id            Int       @id @default(autoincrement())
  userId        Int
  sessionId     Int?
  npsScore      Int?      // 0-10 分
  feedbackText  String?
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id])

  @@map("feedback")
}

// 7. 系统配置表
model Setting {
  id          Int       @id @default(autoincrement())
  key         String    @unique
  value       String?
  description String?
  updatedAt   DateTime  @updatedAt

  @@map("settings")
}

// 8. 管理员日志表
model AdminLog {
  id          Int       @id @default(autoincrement())
  adminName   String    // 管理员用户名
  action      String    // 操作类型：create_code, update_api, etc.
  details     String?   // 操作详情 (JSON)
  createdAt   DateTime  @default(now())

  @@map("admin_logs")
}

// 9. 数据分析洞察表（AI分析结果缓存）
model AnalyticsInsight {
  id            Int       @id @default(autoincrement())
  insightType   String    // 'keywords', 'clusters', 'sentiment', 'trends', 'daily_analysis'
  category      String?   // 分类标签
  content       String    // JSON 格式存储分析结果
  score         Float?    // 相关性或置信度评分
  generatedAt   DateTime  @default(now())
  expiresAt     DateTime? // 缓存过期时间

  @@map("analytics_insights")
}

// 10. 关键词统计表
model Keyword {
  id          Int       @id @default(autoincrement())
  keyword     String    @unique
  category    String?   // 所属类别
  frequency   Int       @default(1)
  trend       String?   // 'up', 'down', 'stable'
  lastUpdated DateTime  @updatedAt

  @@map("keywords")
}

// 11. 主题聚类表
model TopicCluster {
  id            Int       @id @default(autoincrement())
  clusterName   String    // 聚类名称
  description   String?   // 聚类描述
  sessionIds    String    // JSON 数组，存储相关的会话ID
  size          Int       @default(0) // 聚类包含的会话数量
  percentage    Float?    // 占比
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("topic_clusters")
}
