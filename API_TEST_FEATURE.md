# API 测试功能说明

## 功能概述

为管理员后台的 API 配置页面添加了"测试连接"功能，可以在保存前验证 DeepSeek API Key 是否有效。

## 新增功能

### 1. 测试连接按钮 ⚡

在 API 配置页面新增了绿色的"测试连接"按钮，位于"保存配置"按钮左侧。

**功能特点：**
- 🔍 实时测试 API Key 有效性
- 📊 显示详细的测试结果
- ⚠️ 智能错误提示
- 💰 显示 Token 使用情况

### 2. 测试结果显示

测试完成后会显示详细的结果卡片：

#### ✅ 成功情况
- 显示绿色成功提示
- 展示使用的模型名称
- 显示 AI 的测试回复
- 显示 Token 使用统计（输入/输出/总计）

#### ❌ 失败情况
根据不同错误类型显示对应提示：
- **401 错误**: API Key 无效或已过期
- **429 错误**: API 调用频率超限
- **402 错误**: API 账户余额不足
- **网络错误**: 无法连接到服务器
- **其他错误**: 显示具体错误信息

## 使用方法

### 步骤 1: 输入 API Key
在"DeepSeek API Key"输入框中填入您的 API Key

### 步骤 2: 点击测试连接
点击绿色的"测试连接"按钮

### 步骤 3: 查看结果
- 等待几秒钟（测试中...）
- 查看测试结果卡片
- 根据结果决定是否保存配置

### 步骤 4: 保存配置
测试成功后，点击"保存配置"按钮保存 API Key

## 技术实现

### 后端 API
**路径**: `/api/admin/test-api`

**请求方法**: POST

**请求参数**:
```json
{
  "adminUsername": "admin",
  "apiKey": "sk-..."
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "API 连接测试成功！",
  "details": {
    "model": "deepseek-chat",
    "response": "你好！这是测试回复。",
    "usage": {
      "prompt_tokens": 15,
      "completion_tokens": 8,
      "total_tokens": 23
    }
  }
}
```

**失败响应**:
```json
{
  "success": false,
  "error": "API Key 无效或已过期",
  "details": "认证失败"
}
```

### 前端组件
**文件**: `src/app/admin/settings/page.tsx`

**新增状态**:
- `testing`: 测试进行中状态
- `testResult`: 测试结果数据

**新增方法**:
- `handleTestApi()`: 处理测试 API 连接

## 测试消息

测试时会向 DeepSeek API 发送以下消息：
```
你好，这是一个测试消息。请简短回复。
```

**参数设置**:
- `model`: deepseek-chat
- `max_tokens`: 50
- `temperature`: 0.7

## 错误处理

系统会智能识别并处理以下错误：

| 错误类型 | HTTP 状态码 | 用户提示 |
|---------|-----------|---------|
| 认证失败 | 401 | API Key 无效或已过期 |
| 频率限制 | 429 | API 调用频率超限 |
| 余额不足 | 402 | API 账户余额不足 |
| 网络错误 | - | 无法连接到服务器 |
| 其他错误 | 其他 | 显示具体错误信息 |

## 安全性

- ✅ 管理员权限验证
- ✅ API Key 不会在前端明文显示
- ✅ 测试请求使用最小 Token 数
- ✅ 错误信息不泄露敏感数据

## 界面截图说明

### 测试前
- 输入 API Key（密码形式隐藏）
- 绿色"测试连接"按钮
- 蓝色"保存配置"按钮

### 测试中
- 按钮显示"测试中..."
- 按钮禁用状态

### 测试成功
- 绿色成功卡片
- 显示模型信息
- 显示测试回复
- 显示 Token 使用统计

### 测试失败
- 红色错误卡片
- 显示错误类型
- 显示详细错误信息

## 建议使用流程

1. **首次配置**: 输入 API Key → 测试连接 → 确认成功 → 保存配置
2. **更换 API Key**: 输入新 Key → 测试连接 → 确认成功 → 保存配置
3. **故障排查**: 测试连接 → 查看错误信息 → 修正问题 → 重新测试

## 注意事项

⚠️ **重要提示**:
- 测试会消耗少量 API Token（约 20-30 tokens）
- 建议在保存前先测试，避免保存无效的 API Key
- 测试失败不会影响已保存的配置
- 频繁测试可能触发 API 频率限制

## 更新日志

**版本**: v1.1  
**日期**: 2025-12-31  
**更新内容**:
- ✨ 新增 API 连接测试功能
- 📊 新增详细的测试结果展示
- 🔍 新增智能错误识别和提示
- 💰 新增 Token 使用统计显示

