# 用户流程说明

## 用户类型和流程

### 1️⃣ 管理员用户

**账号**: admin / admin

**登录流程**:
```
登录页面 → 输入账号密码 → 自动跳转到管理后台 (/admin)
```

**功能权限**:
- ✅ 管理激活码
- ✅ 配置 API Key
- ✅ 测试 API 连接
- ✅ 查看系统统计
- ✅ 查看管理员日志

---

### 2️⃣ 测试用户（已完成引导）

**账号**: testuser / test

**登录流程**:
```
登录页面 → 输入账号密码 → 直接跳转到仪表板 (/dashboard)
```

**特点**:
- ✅ 已完成引导流程
- ✅ 包含完整的用户资料
- ✅ 可以直接使用教练对话功能
- ✅ 无需填写引导表单

**用途**:
- 快速测试教练对话功能
- 演示完整的用户体验
- 开发调试使用

---

### 3️⃣ 新注册用户（未完成引导）

**注册流程**:
```
注册页面 
  ↓ 填写用户名、密码、激活码
注册成功
  ↓ 清空 onboarding 缓存
引导流程（5步）
  ↓ 步骤 1/5: 欢迎页面
  ↓ 步骤 2/5: 基本信息（用户名、邮箱、角色）
  ↓ 步骤 3/5: 业务线和工作风格
  ↓ 步骤 4/5: 发展目标
  ↓ 步骤 5/5: 工作挑战
完成引导
  ↓ 保存用户信息
仪表板 (/dashboard)
```

**引导流程详情**:

#### 步骤 1/5: 欢迎页面
- 介绍教练伙伴的作用
- 说明信息收集的目的
- 点击"开始"进入下一步

#### 步骤 2/5: 基本信息
- **用户名** (自动填充，不可修改)
- **邮箱** (选填)
- **角色** (必填，下拉选择)
  - 团队负责人/管理者
  - 核心骨干/资深专家
  - 团队成员/执行者

#### 步骤 3/5: 业务线和工作风格
- **业务线** (必填，下拉选择)
  - 技术/研发
  - 产品/运营
  - 市场/销售
  - 人力资源
  - 财务/法务
  - 其他
- **工作风格** (必填，多选)
  - 数据驱动,逻辑严谨
  - 创新思维,敢于尝试
  - 团队协作,注重沟通
  - 目标导向,结果为王
  - 其他

#### 步骤 4/5: 发展目标
- **你目前最关注的发展目标是什么？** (必填，文本框)
- 例如：提升领导力、学习新技能等

#### 步骤 5/5: 工作挑战
- **你当前面临的最大工作挑战是什么？** (必填，文本框)
- 例如：项目延期、跨部门沟通不畅等

---

### 4️⃣ 未完成引导的用户重新登录

**登录流程**:
```
登录页面 
  ↓ 输入账号密码
检测到未完成引导
  ↓ 清空 onboarding 缓存
引导流程（从第1步开始）
  ↓ 完成5个步骤
仪表板 (/dashboard)
```

**特点**:
- ✅ 每次登录都从第1步开始
- ✅ 不保留之前的进度
- ✅ 确保信息收集完整

---

## 关键设计决策

### 为什么测试用户跳过引导流程？

**原因**:
1. **快速测试**: 开发和演示时需要快速访问核心功能
2. **避免重复**: 测试时不需要每次都填写表单
3. **已有数据**: 测试用户已包含完整的用户资料

**实现**:
- 测试用户创建时设置 `onboardingCompleted: true`
- 登录时检测到已完成引导，直接跳转到 dashboard

### 为什么新用户必须完成引导流程？

**原因**:
1. **信息收集**: 需要了解用户的背景和需求
2. **个性化服务**: 根据用户信息提供针对性的教练服务
3. **用户教育**: 通过引导流程让用户了解产品功能

**实现**:
- 新用户创建时设置 `onboardingCompleted: false`
- 登录时检测到未完成引导，跳转到 onboarding 页面
- 完成引导后才能访问 dashboard

### 为什么清空 onboarding 缓存？

**问题**:
- Zustand 的 persist 会将状态保存到 localStorage
- 跨用户会话共享状态
- 新用户可能读取到之前用户的缓存

**解决方案**:
- 注册时清空缓存
- 登录时（未完成引导）清空缓存
- 页面初始化时重置状态

---

## 数据流转

### 注册流程数据流

```
1. 前端：用户填写注册表单
   ↓
2. POST /api/auth/register
   - 验证用户名、密码、激活码
   - 创建用户（onboardingCompleted: false）
   - 标记激活码为已使用
   ↓
3. 返回用户信息和 token
   ↓
4. 前端：保存到 localStorage
   - user: { id, username, isAdmin, onboardingCompleted }
   - token: "..."
   ↓
5. 清空 onboarding 缓存
   ↓
6. 跳转到 /onboarding
```

### 引导流程数据流

```
1. 用户填写5个步骤的表单
   ↓
2. Zustand store 保存表单数据
   - currentStep: 0-4
   - data: { username, email, role, ... }
   ↓
3. 点击"完成"按钮
   ↓
4. POST /api/onboarding/profile
   - 更新用户信息
   - 设置 onboardingCompleted: true
   ↓
5. 返回更新后的用户信息
   ↓
6. 跳转到 /dashboard
```

### 登录流程数据流

```
1. 前端：用户填写登录表单
   ↓
2. POST /api/auth/login
   - 验证用户名和密码
   - 返回用户信息和 token
   ↓
3. 前端：保存到 localStorage
   ↓
4. 判断用户类型：
   - isAdmin = true → /admin
   - onboardingCompleted = false → 清空缓存 → /onboarding
   - onboardingCompleted = true → /dashboard
```

---

## 状态管理

### localStorage 存储

| 键名 | 内容 | 用途 |
|------|------|------|
| `user` | `{ id, username, isAdmin, onboardingCompleted }` | 用户基本信息 |
| `token` | `"base64_string"` | 认证 token |
| `onboarding-storage` | `{ currentStep, data }` | 引导流程状态（会被清空） |
| `user-storage` | `{ username, userId }` | Zustand 用户状态 |
| `session-storage` | `{ currentSessionId, currentScenario }` | 当前会话状态 |

### 关键状态字段

**User.onboardingCompleted**:
- `false`: 未完成引导，登录后跳转到 /onboarding
- `true`: 已完成引导，登录后跳转到 /dashboard

**onboardingStore.currentStep**:
- `0`: 欢迎页面
- `1`: 基本信息
- `2`: 业务线和工作风格
- `3`: 发展目标
- `4`: 工作挑战

---

## 路由保护

### 公开路由
- `/` - 首页
- `/login` - 登录页
- `/register` - 注册页

### 需要登录的路由
- `/onboarding` - 引导流程（未完成引导的用户）
- `/dashboard` - 仪表板（已完成引导的用户）
- `/chat/:id` - 教练对话（已完成引导的用户）

### 管理员路由
- `/admin` - 管理后台
- `/admin/settings` - API 配置
- `/admin/activation-codes` - 激活码管理

---

## 测试场景

### 场景 1: 新用户完整流程
1. 访问注册页面
2. 填写用户名、密码、激活码
3. 注册成功，跳转到引导流程
4. **验证**: 显示"步骤 1/5"
5. 完成5个步骤
6. 点击"完成"
7. **验证**: 跳转到 dashboard

### 场景 2: 测试用户快速登录
1. 访问登录页面
2. 输入 testuser / test
3. 登录成功
4. **验证**: 直接跳转到 dashboard
5. **验证**: 不显示引导流程

### 场景 3: 管理员登录
1. 访问登录页面
2. 输入 admin / admin
3. 登录成功
4. **验证**: 直接跳转到管理后台

### 场景 4: 未完成引导的用户重新登录
1. 注册新用户但不完成引导
2. 退出登录
3. 重新登录
4. **验证**: 跳转到引导流程
5. **验证**: 显示"步骤 1/5"（从头开始）

---

## 常见问题

### Q: 为什么新用户直接跳到第5步？
**A**: 这是之前的 bug，已修复。原因是 onboarding 缓存没有清空。现在注册和登录时会自动清空缓存。

### Q: 测试用户可以重新体验引导流程吗？
**A**: 目前不支持。测试用户已完成引导，会直接跳转到 dashboard。如需测试引导流程，请注册新用户。

### Q: 引导流程可以中途退出吗？
**A**: 可以退出，但下次登录时会从第1步重新开始（不保留进度）。

### Q: 如何修改已完成引导的用户信息？
**A**: 目前需要通过数据库直接修改。后续版本会添加用户资料编辑功能。

---

## 更新日志

**v1.3** (2025-12-31)
- 🐛 修复新用户引导流程从第5步开始的问题
- 🔧 在注册和登录时清空 onboarding 缓存
- ✨ 测试用户默认已完成引导流程
- 📝 完善用户流程文档

**v1.2** (2025-12-31)
- 🐛 修复保存用户信息时的 500 错误
- 🔒 新用户创建时自动生成默认密码

**v1.1** (2025-12-31)
- ✨ 新增 API 连接测试功能
- 📊 新增详细的测试结果展示


