# 初始问题引用优化

## 优化日期
2025-12-31

## 问题描述

### 用户反馈
> "我刚刚测试已经填写了自己的问题，但是一进来仍然是问问题。这样就感觉很不好。我刚刚填写完啊"

### 原有流程
1. 用户在Onboarding步骤5填写具体问题
2. 完成后跳转到对话页面
3. AI显示默认开场白："请告诉我，你现在最想聊什么话题？"
4. **问题**：用户刚填写完问题，又被问一遍，体验很差

## 优化方案

### 新流程
1. 用户在Onboarding步骤5填写具体问题
2. 问题保存到 `sessionStorage`
3. 跳转到对话页面
4. AI开场白中**引用**用户填写的问题
5. AI主动提及这个问题，并引导深入探讨
6. 用户感觉被理解和重视

### 用户体验对比

**优化前：**
```
用户: [在Onboarding填写] "我的团队协作效率很低"
     ↓
[跳转到对话页面]
     ↓
AI: "请告诉我，你现在最想聊什么话题？" ❌ 重复询问
     ↓
用户: [需要再输入一次] "我的团队协作效率很低"
```

**优化后：**
```
用户: [在Onboarding填写] "我的团队协作效率很低"
     ↓
[跳转到对话页面]
     ↓
AI: "你好！我是你的 AI 教练伙伴 🤝

我看到你提到：「我的团队协作效率很低」

很高兴能陪伴你一起探索这个话题...

那么，关于这个问题，你能具体说说是哪方面让你感到困扰吗？" ✅ 主动引用
     ↓
用户: [直接深入探讨，不需要重复]
```

## 技术实现

### 1. Onboarding完成时保存问题

**文件：** `src/app/onboarding/page.tsx`

```typescript
// 保存session信息
setSession(sessionResult.session.id, data.scenario)

// 保存用户填写的初始问题到sessionStorage，chat页面会自动发送
if (data.specificQuestion) {
  sessionStorage.setItem('initialQuestion', data.specificQuestion)
}

// 跳转到对话页面
router.push(`/chat/${sessionResult.session.id}`)
```

**为什么用sessionStorage？**
- ✅ 临时存储，刷新后自动清除
- ✅ 不需要修改数据库结构
- ✅ 只在当前标签页有效
- ✅ 使用后立即删除，避免重复

### 2. Chat页面在开场白中引用初始问题

**文件：** `src/app/chat/[id]/page.tsx`

```typescript
// 如果是新会话，显示开场白（可能包含用户的初始问题）
if (historyMessages.length === 0) {
  const initialQuestion = sessionStorage.getItem('initialQuestion')
  
  let welcomeMessage = ''
  
  if (initialQuestion) {
    // 用户在Onboarding中填写了问题，在开场白中引用
    console.log('检测到初始问题，在开场白中引用:', initialQuestion)
    sessionStorage.removeItem('initialQuestion') // 清除，避免重复使用
    
    welcomeMessage = `你好！我是你的 AI 教练伙伴 🤝

我看到你提到：「${initialQuestion}」

很高兴能陪伴你一起探索这个话题。作为教练，我不会直接给你答案，而是通过提问帮助你自己找到解决方案。

那么，关于这个问题，你能具体说说是哪方面让你感到困扰吗？或者从最让你头疼的地方开始？`
  } else {
    // 没有初始问题，显示默认开场白
    console.log('显示默认开场白...')
    welcomeMessage = `你好！我是你的 AI 教练伙伴 🤝

我看到你在用户画像中提到的工作挑战，很高兴能陪伴你一起探索和思考。

作为教练，我不会直接给你答案，而是通过提问帮助你自己找到解决方案。

请告诉我，你现在最想聊什么话题？或者从你的工作挑战开始？`
  }
  
  setMessages([{
    id: Date.now(),
    role: 'assistant',
    content: welcomeMessage,
    createdAt: new Date().toISOString(),
  }])
}
```

## 实现细节

### 1. 在开场白中引用问题
```typescript
welcomeMessage = `你好！我是你的 AI 教练伙伴 🤝

我看到你提到：「${initialQuestion}」

很高兴能陪伴你一起探索这个话题...`
```

**为什么这样设计？**
- AI主动提及用户的问题，显示关注和理解
- 用户感觉被重视，不需要重复
- 保持对话的自然流畅
- 教练式引导，而非简单重复

### 2. 立即清除sessionStorage
```typescript
sessionStorage.removeItem('initialQuestion')
```

**为什么立即清除？**
- 避免刷新页面时重复发送
- 避免返回后再次触发
- 确保只使用一次

### 3. 保留默认开场白
```typescript
if (initialQuestion) {
  // 在开场白中引用问题
  welcomeMessage = `我看到你提到：「${initialQuestion}」...`
} else {
  // 显示默认开场白
  welcomeMessage = `请告诉我，你现在最想聊什么话题？...`
}
```

**为什么保留？**
- 从Dashboard直接进入的用户没有初始问题
- 需要显示友好的欢迎信息
- 向后兼容

### 4. 不自动发送消息
**重要决策：** 不自动发送用户的消息，而是在AI的开场白中引用

**原因：**
- 保持教练的主动性和引导性
- 用户看到的第一条消息是AI的欢迎
- 更符合教练对话的自然流程
- 用户可以根据AI的引导深入探讨

## 使用场景

### 场景1：新用户注册（有初始问题）
```
注册 → Onboarding → 填写问题 → 自动发送 → 看到AI回复 ✅
```

### 场景2：老用户从Dashboard开启新对话（无初始问题）
```
Dashboard → 点击"开始对话" → 看到默认开场白 → 手动输入 ✅
```

### 场景3：用户刷新对话页面
```
刷新页面 → sessionStorage已清除 → 显示历史消息 ✅
```

## 优势总结

1. ✅ **避免重复询问**：AI主动提及用户的问题
2. ✅ **体验更自然**：教练式引导，而非机械重复
3. ✅ **用户感觉被理解**：问题被看到和重视
4. ✅ **保持对话流畅**：AI主导开场，更专业
5. ✅ **不修改数据库**：实现简单，无风险
6. ✅ **向后兼容**：不影响现有功能
7. ✅ **符合教练理念**：主动关注，引导探索

## 注意事项

### 1. sessionStorage的限制
- 只在当前标签页有效
- 关闭标签页后自动清除
- 不能跨域共享

### 2. 边界情况处理
- ✅ 如果用户在500ms内关闭页面，不会发送
- ✅ 如果API调用失败，显示错误提示
- ✅ 如果用户刷新页面，不会重复发送

### 3. 调试日志
```typescript
console.log('检测到初始问题，自动发送:', initialQuestion)
```
方便开发时追踪问题

## 测试验证

### 测试1：新用户完整流程
1. 注册新账号
2. 完成Onboarding，填写问题："团队沟通效率低"
3. 进入对话页面
4. **期望**：AI开场白中提到"我看到你提到：「团队沟通效率低」"

### 测试2：老用户新对话
1. 登录已有账号
2. 从Dashboard点击"开始对话"
3. **期望**：显示默认开场白

### 测试3：刷新页面
1. 在对话页面刷新
2. **期望**：显示历史消息，不重复发送

### 测试4：返回重新进入
1. 完成Onboarding，进入对话页面
2. 返回Dashboard
3. 再次点击"开始对话"
4. **期望**：显示默认开场白（sessionStorage已清除）

## 后续优化建议

### 1. 优化开场白文案
根据不同场景（工作难题/职业发展）定制不同的开场白

### 2. 添加更多上下文
在开场白中引用用户的角色、业务线等信息

### 3. A/B测试
测试不同的开场白文案，找到最有效的版本

### 4. 记录用户行为
统计有多少用户从Onboarding直接进入对话

## 总结

这次优化：
- ✅ 解决了用户反馈的重复询问问题
- ✅ 提升了首次对话的流畅度
- ✅ 实现简单，无需数据库迁移
- ✅ 向后兼容，不影响现有用户

**核心理念：尊重用户已经提供的信息，避免重复询问，让体验更流畅自然。**

