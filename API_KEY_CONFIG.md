# API Key 配置说明

## 当前状态

### ✅ 您现在可以对话

**原因**: 系统使用了环境变量中的 API Key

### 📍 API Key 来源

系统有**两种方式**配置 API Key，按优先级排序：

#### 1️⃣ 管理员后台配置（优先级高）
- 路径: `/admin/settings`
- 存储: 数据库 `settings` 表
- 优点: 可以随时修改，无需重启服务器
- **当前状态**: ❌ 未配置

#### 2️⃣ 环境变量配置（降级方案）
- 文件: `.env.local`
- 配置: `DEEPSEEK_API_KEY=sk-d1878ae2ae404464ac795269c5157d00`
- 优点: 开发环境方便
- **当前状态**: ✅ 已配置

### 🔍 代码逻辑

```typescript
// src/app/api/coaching/chat/route.ts

// 从数据库获取 API Key
const apiKeySetting = await prisma.setting.findUnique({
  where: { key: 'deepseek_api_key' },
});

// 降级机制：数据库 → 环境变量
const deepseekApiKey = apiKeySetting?.value || process.env.DEEPSEEK_API_KEY;

if (!deepseekApiKey) {
  return new Response(
    JSON.stringify({ error: 'DeepSeek API 未配置，请联系管理员' }),
    { status: 503 }
  )
}
```

**逻辑说明**:
1. 先查询数据库中的配置
2. 如果数据库没有，使用环境变量
3. 如果都没有，返回错误

## 两种配置方式对比

| 特性 | 管理员后台配置 | 环境变量配置 |
|------|---------------|-------------|
| **优先级** | 高 | 低 |
| **修改方式** | 网页界面 | 编辑文件 |
| **生效时间** | 立即生效 | 需要重启 |
| **适用场景** | 生产环境 | 开发环境 |
| **安全性** | 高（数据库） | 中（文件） |
| **便捷性** | 高 | 中 |

## 推荐配置方式

### 开发环境 💻
**推荐**: 使用环境变量（`.env.local`）

**原因**:
- ✅ 方便快速测试
- ✅ 不需要每次都登录管理后台
- ✅ 可以版本控制（注意不要提交到 Git）

**配置步骤**:
```bash
# 1. 创建 .env.local 文件
echo 'DEEPSEEK_API_KEY=sk-your-api-key-here' > .env.local

# 2. 重启开发服务器
npm run dev
```

### 生产环境 🚀
**推荐**: 使用管理员后台配置

**原因**:
- ✅ 可以随时修改，无需重启
- ✅ 支持测试连接功能
- ✅ 更安全（存储在数据库）
- ✅ 有操作日志记录

**配置步骤**:
1. 登录管理员账号 (admin/admin)
2. 进入"API 配置"页面
3. 输入 DeepSeek API Key
4. 点击"测试连接"验证
5. 点击"保存配置"

## 当前您的情况

### 现状分析

```
┌─────────────────────────────────────┐
│  管理员后台配置                      │
│  ❌ 未配置                          │
│  (数据库中没有记录)                  │
└─────────────────────────────────────┘
              ↓ 降级
┌─────────────────────────────────────┐
│  环境变量配置                        │
│  ✅ 已配置                          │
│  sk-d1878ae2ae404464...             │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  系统使用环境变量中的 API Key        │
│  ✅ 对话功能正常工作                │
└─────────────────────────────────────┘
```

### 建议操作

#### 选项 1: 继续使用环境变量（推荐用于开发）
**操作**: 无需任何操作，继续使用即可

**优点**:
- ✅ 已经配置好，直接使用
- ✅ 开发环境方便

**缺点**:
- ❌ 部署到生产环境时需要重新配置
- ❌ 修改需要重启服务器

#### 选项 2: 迁移到管理员后台（推荐用于生产）
**操作步骤**:

1. **登录管理后台**
   ```
   访问: http://localhost:3000/login
   用户名: admin
   密码: admin
   ```

2. **进入 API 配置**
   ```
   点击: API 配置
   或访问: http://localhost:3000/admin/settings
   ```

3. **配置 API Key**
   ```
   输入: sk-d1878ae2ae404464ac795269c5157d00
   点击: 测试连接
   等待: 测试成功
   点击: 保存配置
   ```

4. **验证配置**
   ```
   刷新对话页面
   发送测试消息
   确认正常工作
   ```

**优点**:
- ✅ 可以随时修改
- ✅ 支持测试功能
- ✅ 有操作日志
- ✅ 更安全

## 测试 API Key 配置

### 方法 1: 通过管理后台测试

1. 登录管理后台
2. 进入 API 配置页面
3. 输入 API Key
4. 点击"测试连接"按钮
5. 查看测试结果

**测试成功示例**:
```json
{
  "success": true,
  "message": "API 连接测试成功！",
  "details": {
    "model": "deepseek-chat",
    "response": "你好！这是测试回复。",
    "usage": {
      "prompt_tokens": 15,
      "completion_tokens": 8,
      "total_tokens": 23
    }
  }
}
```

### 方法 2: 通过对话测试

1. 登录测试用户 (testuser/test)
2. 进入仪表板
3. 点击"开始对话"
4. 发送测试消息
5. 查看 AI 回复

**成功标志**:
- ✅ 收到 AI 回复
- ✅ 回复内容合理
- ✅ 没有错误提示

### 方法 3: 查看日志

```bash
# 查看开发服务器日志
# 应该看到类似的输出：
Deepseek API调用，消息历史长度: 3
```

## 常见问题

### Q1: 为什么管理后台显示没有配置，但能正常对话？
**A**: 因为系统使用了环境变量中的 API Key 作为降级方案。

### Q2: 我应该使用哪种配置方式？
**A**: 
- 开发环境：环境变量（`.env.local`）
- 生产环境：管理员后台配置

### Q3: 两种配置可以同时存在吗？
**A**: 可以。管理员后台配置优先级更高，会覆盖环境变量。

### Q4: 如何查看当前使用的是哪个 API Key？
**A**: 
- 查看管理后台是否有配置
- 如果有，使用管理后台的
- 如果没有，使用环境变量的

### Q5: 修改环境变量后需要重启吗？
**A**: 是的，需要重启开发服务器：
```bash
# 停止服务器 (Ctrl+C)
# 重新启动
npm run dev
```

### Q6: 修改管理后台配置需要重启吗？
**A**: 不需要，立即生效。

## 安全建议

### ⚠️ 重要提示

1. **不要将 API Key 提交到 Git**
   ```bash
   # .gitignore 中应该包含
   .env.local
   .env*.local
   ```

2. **定期更换 API Key**
   - 建议每 3-6 个月更换一次
   - 如果怀疑泄露，立即更换

3. **限制 API Key 权限**
   - 在 DeepSeek 平台设置使用限额
   - 设置 IP 白名单（如果支持）

4. **监控 API 使用情况**
   - 定期检查 DeepSeek 平台的使用统计
   - 发现异常立即处理

## 部署到生产环境

### Railway 部署

1. **设置环境变量**
   ```
   在 Railway 项目设置中添加：
   DEEPSEEK_API_KEY=sk-your-api-key-here
   ```

2. **或使用管理后台配置**
   ```
   部署后登录管理后台
   在 API 配置页面设置
   ```

**推荐**: 使用管理后台配置，更灵活

### Vercel 部署

1. **设置环境变量**
   ```
   在 Vercel 项目设置中添加：
   DEEPSEEK_API_KEY=sk-your-api-key-here
   ```

2. **重新部署**
   ```
   环境变量修改后需要重新部署
   ```

## 总结

### 当前状态 ✅
- 您的系统使用环境变量中的 API Key
- 对话功能正常工作
- 无需立即修改

### 建议操作 💡
- **开发阶段**: 继续使用环境变量
- **准备上线**: 迁移到管理员后台配置
- **生产环境**: 使用管理员后台配置

### 优先级配置逻辑 🔄
```
管理员后台配置 (优先)
    ↓ 如果没有
环境变量配置 (降级)
    ↓ 如果都没有
返回错误提示
```

---

**最后更新**: 2025-12-31  
**版本**: v1.0

