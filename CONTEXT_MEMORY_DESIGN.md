# 上下文记忆设计优化

## 优化日期
2025-12-31

## 设计理念

### 用户反馈
> "老的字段确实可以起作用，提炼风格和记忆后作为更了解用户的长期记忆，这个是没有问题的，但是新的问题，解决新的问题还是要分清楚的。回答可以融合以前的问题来解决，这个可以保留记忆。"

### 核心原则

**长期记忆 + 当前主题 = 智能融合**

1. **保留历史信息**：作为长期记忆，帮助AI更了解用户
2. **明确当前主题**：清楚知道现在在讨论什么
3. **智能融合**：可以引用历史经验，但不能混淆主题

## 系统提示词设计

### 最终方案

```typescript
const userProfile = `
角色：${session.user.role || '未设置'}
业务线：${session.user.businessLine || '未设置'}
工作风格：${session.user.workStyle || '未设置'}

【用户历史背景】（作为参考，非当前讨论重点）
- 曾关注的发展目标：${session.user.developmentGoal || '未记录'}
- 曾提到的工作挑战：${session.user.workChallenge || '未记录'}

⚠️ 重要提示：以上是用户的历史背景信息，可以作为了解用户的参考。
但请务必以当前对话历史中的内容为主，不要混淆历史背景和当前讨论的主题。
你可以在适当时候融合历史经验来帮助用户，但要清楚区分。
`.trim()
```

### 设计要点

#### 1. 明确标注"历史背景"
```
【用户历史背景】（作为参考，非当前讨论重点）
```
- 用特殊标记区分历史和当前
- 明确说明这是"参考"而非"主题"

#### 2. 给AI明确指令
```
⚠️ 重要提示：请务必以当前对话历史中的内容为主
```
- 告诉AI优先级：当前对话 > 历史背景
- 允许融合，但要清楚区分

#### 3. 保留灵活性
```
你可以在适当时候融合历史经验来帮助用户
```
- 不是完全忽略历史
- 而是智能地融合使用

## 使用场景示例

### 场景1：当前主题优先

**用户历史背景：**
- 曾关注：提升领导力
- 曾挑战：bop业务支持不强

**当前对话：**
- 用户："COE岗位没有发挥价值"
- AI："我看到你提到COE岗位的问题..." ✅

**正确行为：**
- 聚焦当前问题："COE岗位"
- 不提及历史问题："bop业务"

### 场景2：智能融合历史

**用户历史背景：**
- 曾关注：提升领导力
- 曾挑战：团队协作困难

**当前对话：**
- 用户："我想提升自己的影响力"
- AI："我注意到你之前关注过领导力的提升，这次想聚焦影响力。这两者有很多相通之处..." ✅

**正确行为：**
- 识别关联："领导力"和"影响力"相关
- 融合经验：引用历史，但聚焦当前
- 明确区分：说明"之前"和"这次"

### 场景3：发现模式

**用户历史背景：**
- 曾挑战：跨部门沟通不畅

**当前对话：**
- 用户："项目推进总是遇到阻力"
- AI："能具体说说是什么样的阻力吗？比如是资源问题、沟通问题，还是其他方面？" 
- 用户："主要是其他部门不配合"
- AI："我注意到你之前也提到过跨部门沟通的挑战。看起来这可能是一个持续的模式。那么这次的情况和之前有什么相似或不同之处呢？" ✅

**正确行为：**
- 发现模式：识别重复出现的问题
- 建立连接：帮助用户看到更大的图景
- 深入探索：引导用户反思模式

## 数据结构

### User表（长期记忆）
```typescript
{
  role: string,              // 稳定信息
  businessLine: string,      // 稳定信息
  workStyle: string,         // 稳定信息
  developmentGoal: string,   // 历史背景
  workChallenge: string,     // 历史背景
}
```

**特点：**
- 跨session共享
- 作为背景参考
- 不频繁更新

### Session表（当前主题）
```typescript
{
  scenario: string,          // 当前场景
  messages: Message[],       // 对话历史
}
```

**特点：**
- session独立
- 当前讨论的主题
- 优先级最高

### 信息层级

```
优先级 1：当前对话历史
├─ 最近3轮对话（最重要）
├─ 本session所有对话
└─ 开场白中的初始问题

优先级 2：用户画像
├─ 角色、业务线、工作风格（稳定信息）
└─ 历史目标和挑战（背景参考）

优先级 3：系统知识
└─ GROW模型、教练技巧等
```

## AI行为准则

### ✅ 应该做的

1. **优先关注当前对话**
   - 始终以对话历史为主
   - 回应用户当前的问题和情绪

2. **适时引用历史**
   - 发现模式时："我注意到你之前也提到过..."
   - 建立连接时："这和你之前关注的X有关联..."
   - 提供视角时："结合你之前的经验..."

3. **明确区分时间**
   - 使用"之前"、"这次"、"现在"等时间标记
   - 让用户清楚知道你在谈论什么

### ❌ 不应该做的

1. **不要混淆主题**
   - ❌ "你提到bop业务支持不强..."（当前没提到）
   - ✅ "你这次提到COE岗位的问题..."

2. **不要突然转换话题**
   - ❌ 从"COE岗位"突然跳到"bop业务"
   - ✅ 如果要引用历史，先说明："这让我想到你之前提到的..."

3. **不要过度依赖历史**
   - ❌ 一直谈论历史问题
   - ✅ 以当前为主，历史为辅

## 测试场景

### 测试1：不混淆主题
```
历史：提升领导力
当前：团队协作效率低

期望：AI聚焦"团队协作"，不提"领导力"
```

### 测试2：智能融合
```
历史：跨部门沟通困难
当前：项目推进遇阻，其他部门不配合

期望：AI识别模式，引用历史，但聚焦当前
示例："我注意到你之前也提到过跨部门沟通的挑战..."
```

### 测试3：发现关联
```
历史：提升领导力
当前：如何影响团队决策

期望：AI发现关联，建立连接
示例："这和你之前关注的领导力提升有关联..."
```

## 优势总结

### 相比完全移除历史信息
- ✅ **更智能**：能发现模式和关联
- ✅ **更个性化**：基于用户历史提供建议
- ✅ **更有深度**：帮助用户看到更大的图景

### 相比直接使用历史信息
- ✅ **不混淆**：明确区分历史和当前
- ✅ **有重点**：当前对话优先
- ✅ **更清晰**：用户知道AI在谈论什么

## 实施效果

**优化前：**
```
用户："COE岗位没有发挥价值"
AI："我看到你提到COE岗位..." ✅
用户："我也不知道从哪里说起"
AI："你提到bop业务支持不强..." ❌ 混淆了
```

**优化后：**
```
用户："COE岗位没有发挥价值"
AI："我看到你提到COE岗位..." ✅
用户："我也不知道从哪里说起"
AI："关于COE岗位的问题，我们可以从几个方面来探讨..." ✅

或者（如果发现关联）：
AI："关于COE岗位的价值发挥，我注意到你之前也关注过类似的组织效能问题。
这次的情况有什么特别之处吗？" ✅ 融合但不混淆
```

## 总结

这次优化：
- ✅ 保留了历史信息的价值（长期记忆）
- ✅ 明确了当前主题的优先级
- ✅ 允许AI智能融合历史经验
- ✅ 避免了混淆和"窜台"

**核心理念：** 历史是背景，当前是重点，融合是智慧。


