# å¼•å¯¼æµç¨‹é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

### é—®é¢˜ 1: æµ‹è¯•ç”¨æˆ·éœ€è¦å¡«å†™å¼•å¯¼è¡¨å•
**ç°è±¡**: æµ‹è¯•ç”¨æˆ·ç™»å½•åè¢«è¦æ±‚å¡«å†™å¼•å¯¼è¡¨å•ï¼ˆæ­¥éª¤ 2/5 å’Œ 5/5ï¼‰

**åŸå› **: æµ‹è¯•ç”¨æˆ·åˆ›å»ºæ—¶ `onboardingCompleted` è®¾ç½®ä¸º `false`

**å½±å“**: æµ‹è¯•ç”¨æˆ·æ— æ³•å¿«é€Ÿä½“éªŒæ ¸å¿ƒåŠŸèƒ½

### é—®é¢˜ 2: ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶æŠ¥é”™ 500
**ç°è±¡**: å®Œæˆå¼•å¯¼æµç¨‹æœ€åä¸€æ­¥ç‚¹å‡»"å®Œæˆ"æ—¶æŠ¥é”™

**é”™è¯¯ä¿¡æ¯**: 
```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
api/onboarding/profile:1
```

**åŸå› **: 
1. Onboarding API åœ¨åˆ›å»ºæ–°ç”¨æˆ·æ—¶ç¼ºå°‘å¿…å¡«çš„ `password` å­—æ®µ
2. User è¡¨çš„ `password` å­—æ®µæ˜¯å¿…å¡«çš„ï¼Œä½† API æ²¡æœ‰æä¾›

**å½±å“**: ç”¨æˆ·æ— æ³•å®Œæˆæ³¨å†Œæµç¨‹

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: æµ‹è¯•ç”¨æˆ·é»˜è®¤å®Œæˆå¼•å¯¼

**ä¿®æ”¹æ–‡ä»¶**: `scripts/reset-admin.js`

**ä¿®æ”¹å†…å®¹**:
```javascript
// ä¿®æ”¹å‰
const testUser = await prisma.user.create({
  data: {
    username: 'testuser',
    password: testHashedPassword,
    isAdmin: false,
    onboardingCompleted: false,  // âŒ è®¾ç½®ä¸º false
    email: 'test@example.com',
  },
});

// ä¿®æ”¹å
const testUser = await prisma.user.create({
  data: {
    username: 'testuser',
    password: testHashedPassword,
    isAdmin: false,
    onboardingCompleted: true,  // âœ… è®¾ç½®ä¸º true
    email: 'test@example.com',
    role: 'å›¢é˜Ÿè´Ÿè´£äºº/ç®¡ç†è€…',
    businessLine: 'æŠ€æœ¯/ç ”å‘',
    workStyle: 'æ•°æ®é©±åŠ¨,é€»è¾‘ä¸¥è°¨',
    developmentGoal: 'æå‡é¢†å¯¼åŠ›å’Œå›¢é˜Ÿç®¡ç†èƒ½åŠ›',
    workChallenge: 'å¹³è¡¡æŠ€æœ¯å·¥ä½œå’Œç®¡ç†èŒè´£',
  },
});
```

**æ•ˆæœ**:
- âœ… æµ‹è¯•ç”¨æˆ·ç™»å½•åç›´æ¥è¿›å…¥ä»ªè¡¨æ¿
- âœ… æ— éœ€å¡«å†™å¼•å¯¼è¡¨å•
- âœ… å¯ä»¥ç«‹å³ä½¿ç”¨æ•™ç»ƒå¯¹è¯åŠŸèƒ½

### ä¿®å¤ 2: Onboarding API æ”¯æŒåˆ›å»ºæ–°ç”¨æˆ·

**ä¿®æ”¹æ–‡ä»¶**: `src/app/api/onboarding/profile/route.ts`

**ä¿®æ”¹å†…å®¹**:

1. **æ·»åŠ å¯†ç å“ˆå¸Œå‡½æ•°**:
```typescript
import * as crypto from 'crypto'

function hashPassword(password: string): string {
  return crypto.createHash('sha256').update(password).digest('hex');
}
```

2. **ä¿®æ”¹ç”¨æˆ·åˆ›å»ºé€»è¾‘**:
```typescript
// ä¿®æ”¹å‰ - ä½¿ç”¨ upsertï¼Œcreate æ—¶ç¼ºå°‘ password
const user = await prisma.user.upsert({
  where: { username },
  update: { /* ... */ },
  create: {
    username,
    email,
    // âŒ ç¼ºå°‘ password å­—æ®µ
    role,
    businessLine,
    // ...
  },
})

// ä¿®æ”¹å - åˆ†åˆ«å¤„ç†æ›´æ–°å’Œåˆ›å»º
const existingUser = await prisma.user.findUnique({
  where: { username }
})

let user
if (existingUser) {
  // ç”¨æˆ·å·²å­˜åœ¨ï¼Œåªæ›´æ–° onboarding ç›¸å…³å­—æ®µ
  user = await prisma.user.update({
    where: { username },
    data: {
      email,
      role,
      businessLine,
      workStyle,
      developmentGoal,
      workChallenge,
      onboardingCompleted: true,
    },
  })
} else {
  // æ–°ç”¨æˆ·ï¼Œéœ€è¦åˆ›å»ºå¯†ç ï¼ˆä½¿ç”¨ç”¨æˆ·åä½œä¸ºé»˜è®¤å¯†ç ï¼‰
  const defaultPassword = hashPassword(username)
  user = await prisma.user.create({
    data: {
      username,
      password: defaultPassword,  // âœ… æ·»åŠ å¯†ç å­—æ®µ
      email,
      role,
      businessLine,
      workStyle,
      developmentGoal,
      workChallenge,
      onboardingCompleted: true,
    },
  })
}
```

**æ•ˆæœ**:
- âœ… æ–°ç”¨æˆ·å¯ä»¥é€šè¿‡å¼•å¯¼æµç¨‹å®Œæˆæ³¨å†Œ
- âœ… é»˜è®¤å¯†ç ä¸ºç”¨æˆ·åï¼ˆç”¨æˆ·å¯ä»¥åç»­ä¿®æ”¹ï¼‰
- âœ… å·²å­˜åœ¨çš„ç”¨æˆ·åªæ›´æ–°ä¿¡æ¯ï¼Œä¸ä¿®æ”¹å¯†ç 
- âœ… ä¸å†å‡ºç° 500 é”™è¯¯

## æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: æµ‹è¯•ç”¨æˆ·ç™»å½•
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"test"}'
```

**é¢„æœŸç»“æœ**:
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "user": {
    "id": 4,
    "username": "testuser",
    "isAdmin": false,
    "onboardingCompleted": true  // âœ… å·²å®Œæˆå¼•å¯¼
  },
  "token": "..."
}
```

**å®é™…ç»“æœ**: âœ… é€šè¿‡

### æµ‹è¯• 2: æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹
1. è®¿é—®æ³¨å†Œé¡µé¢
2. å¡«å†™ç”¨æˆ·åã€å¯†ç ã€æ¿€æ´»ç 
3. å®Œæˆå¼•å¯¼æµç¨‹ï¼ˆ5ä¸ªæ­¥éª¤ï¼‰
4. ç‚¹å‡»"å®Œæˆ"æŒ‰é’®

**é¢„æœŸç»“æœ**: 
- âœ… æˆåŠŸä¿å­˜ç”¨æˆ·ä¿¡æ¯
- âœ… è·³è½¬åˆ°ä»ªè¡¨æ¿
- âœ… æ—  500 é”™è¯¯

**å®é™…ç»“æœ**: âœ… é€šè¿‡

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
1. `scripts/reset-admin.js` - æµ‹è¯•ç”¨æˆ·åˆ›å»ºè„šæœ¬
2. `src/app/api/onboarding/profile/route.ts` - å¼•å¯¼æµç¨‹ API

### å—å½±å“çš„åŠŸèƒ½
1. âœ… æµ‹è¯•ç”¨æˆ·ç™»å½•æµç¨‹
2. âœ… æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹
3. âœ… å¼•å¯¼æµç¨‹å®Œæˆ

### ä¸å—å½±å“çš„åŠŸèƒ½
- âœ… ç®¡ç†å‘˜ç™»å½•
- âœ… ç°æœ‰ç”¨æˆ·ç™»å½•
- âœ… æ•™ç»ƒå¯¹è¯åŠŸèƒ½
- âœ… ä¼šè¯ç®¡ç†
- âœ… æŠ¥å‘Šç”Ÿæˆ

## éƒ¨ç½²è¯´æ˜

### æœ¬åœ°å¼€å‘ç¯å¢ƒ
1. è¿è¡Œé‡ç½®è„šæœ¬æ›´æ–°æµ‹è¯•ç”¨æˆ·ï¼š
   ```bash
   node scripts/reset-admin.js
   ```

2. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   ```bash
   npm run dev
   ```

### ç”Ÿäº§ç¯å¢ƒ
1. éƒ¨ç½²ä»£ç æ›´æ–°
2. æ— éœ€è¿è¡Œè¿ç§»ï¼ˆæ•°æ®åº“ç»“æ„æœªå˜ï¼‰
3. ç°æœ‰ç”¨æˆ·ä¸å—å½±å“
4. æ–°ç”¨æˆ·å¯ä»¥æ­£å¸¸æ³¨å†Œ

## æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æç¤º**:

1. **é»˜è®¤å¯†ç å®‰å…¨æ€§**
   - æ–°ç”¨æˆ·é€šè¿‡å¼•å¯¼æµç¨‹åˆ›å»ºæ—¶ï¼Œé»˜è®¤å¯†ç ä¸ºç”¨æˆ·å
   - å»ºè®®åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ å¯†ç ä¿®æ”¹åŠŸèƒ½
   - æˆ–åœ¨æ³¨å†Œæ—¶è¦æ±‚ç”¨æˆ·è®¾ç½®å¯†ç 

2. **æµ‹è¯•ç”¨æˆ·æ•°æ®**
   - æµ‹è¯•ç”¨æˆ·ç°åœ¨åŒ…å«å®Œæ•´çš„ profile ä¿¡æ¯
   - å¯ä»¥ç›´æ¥ç”¨äºæµ‹è¯•æ•™ç»ƒå¯¹è¯åŠŸèƒ½
   - æ— éœ€æ‰‹åŠ¨å¡«å†™å¼•å¯¼è¡¨å•

3. **å‘åå…¼å®¹æ€§**
   - ä¿®æ”¹å®Œå…¨å‘åå…¼å®¹
   - ç°æœ‰ç”¨æˆ·æ•°æ®ä¸å—å½±å“
   - API è¡Œä¸ºå¯¹ç°æœ‰ç”¨æˆ·ä¿æŒä¸å˜

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. æ·»åŠ å¯†ç ä¿®æ”¹åŠŸèƒ½
2. åœ¨æ³¨å†Œæ—¶è®©ç”¨æˆ·è®¾ç½®å¯†ç ï¼ˆè€Œä¸æ˜¯åœ¨å¼•å¯¼æµç¨‹åï¼‰
3. æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯

### é•¿æœŸä¼˜åŒ–
1. å®ç°å®Œæ•´çš„ç”¨æˆ·èµ„æ–™ç¼–è¾‘åŠŸèƒ½
2. æ·»åŠ é‚®ç®±éªŒè¯æµç¨‹
3. æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
4. å®ç°å¯†ç é‡ç½®åŠŸèƒ½

## æ›´æ–°æ—¥å¿—

**ç‰ˆæœ¬**: v1.2  
**æ—¥æœŸ**: 2025-12-31  
**ç±»å‹**: Bug Fix

**ä¿®å¤å†…å®¹**:
- ğŸ› ä¿®å¤æµ‹è¯•ç”¨æˆ·éœ€è¦å¡«å†™å¼•å¯¼è¡¨å•çš„é—®é¢˜
- ğŸ› ä¿®å¤ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶çš„ 500 é”™è¯¯
- âœ¨ æµ‹è¯•ç”¨æˆ·ç°åœ¨åŒ…å«å®Œæ•´çš„ profile ä¿¡æ¯
- ğŸ”’ æ–°ç”¨æˆ·åˆ›å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆé»˜è®¤å¯†ç 

**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡


